<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit Master - Multi-Device Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100%; width: 100%; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-safe { padding-top: max(1.25rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1.25rem, var(--safe-bottom)); }
        .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        ::-webkit-scrollbar { display: none; }
        
        .dark-mode { background-color: #0f172a; color: #f1f5f9; }
        .dark-card { background-color: #1e293b; border-color: #334155; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 모바일 터치 최적화 */
        button, input, textarea { -webkit-tap-highlight-color: transparent; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#FFF5F7]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query, getDocs, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query, getDocs, updateDoc, where };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [toons, setToons] = useState([]);
            const [user, setUser] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [isSettings, setIsSettings] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), status: 'Idea' });
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('toonkit_dark') === 'true');
            const [pin, setPin] = useState(localStorage.getItem('toonkit_pin') || '');
            const [showPinEntry, setShowPinEntry] = useState(!!localStorage.getItem('toonkit_pin'));
            const [pinInput, setPinInput] = useState('');

            const dbRef = useRef(null);
            const authRef = useRef(null);
            // 모든 기기가 동일한 데이터를 보게 하는 핵심 앱 ID
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-v1';
            const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzjF4-7CgHPX7p2sLOYzwUff6sqvYCyx3HLp3BUBWBC1pxrRy022xUKLt4jmbTTY2HBQA/exec";

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot } = window.FB;
                    
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        authRef.current = getAuth(app);
                        dbRef.current = getFirestore(app);

                        // 1. 인증 시작 (Rule 3)
                        const authMethod = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(authRef.current, __initial_auth_token);
                            } else {
                                await signInAnonymously(authRef.current);
                            }
                        };
                        await authMethod();

                        // 2. 인증 상태 리스너 & 데이터 실시간 바인딩
                        onAuthStateChanged(authRef.current, (u) => {
                            if (u) {
                                setUser(u);
                                // 기기 구분 없이 appId 내의 모든 toon 데이터를 실시간 감시
                                const q = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'toons');
                                
                                const unsubscribe = onSnapshot(q, (snapshot) => {
                                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    // 최신 수정순 정렬
                                    data.sort((a, b) => {
                                        const timeA = a.updatedAt?.seconds || 0;
                                        const timeB = b.updatedAt?.seconds || 0;
                                        return timeB - timeA;
                                    });
                                    setToons(data);
                                    setLoading(false);
                                    setTimeout(() => window.lucide && window.lucide.createIcons(), 100);
                                }, (err) => {
                                    console.error("실시간 동기화 오류:", err);
                                    setLoading(false);
                                });

                                return () => unsubscribe();
                            }
                        });
                    } catch (e) {
                        console.error("초기화 오류:", e);
                        setLoading(false);
                    }
                };

                const checkFB = setInterval(() => { if(window.FB) { initFirebase(); clearInterval(checkFB); } }, 200);
                return () => clearInterval(checkFB);
            }, []);

            // 구글 로그인 (계정 통합의 핵심)
            const handleGoogleLogin = async () => {
                const { GoogleAuthProvider, signInWithPopup } = window.FB;
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(authRef.current, provider);
                } catch (e) {
                    alert("구글 연동 중 오류가 발생했습니다.");
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.FB;
                await signOut(authRef.current);
                window.location.reload();
            };

            // 스프레드시트 전송 함수
            const saveToSheet = async (data) => {
                if (!SHEET_WEBHOOK_URL) return;
                try {
                    await fetch(SHEET_WEBHOOK_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            ...data, 
                            author: user?.displayName || user?.uid, 
                            updatedAt: new Date().toLocaleString(),
                            device: navigator.userAgent.includes('Mobile') ? 'Mobile' : 'PC'
                        })
                    });
                } catch (e) { console.error("Sheet Sync Error"); }
            };

            const handleSave = async () => {
                if (!user || !currentToon.title.trim()) return;
                setIsSyncing(true);
                const { doc, setDoc, serverTimestamp } = window.FB;
                
                // 기존 ID가 있으면 덮어쓰기(편집), 없으면 새 ID 생성
                const toonId = currentToon.id || `toon_${Date.now()}`;
                
                try {
                    const toonData = { 
                        ...currentToon, 
                        id: toonId, 
                        updatedAt: serverTimestamp(),
                        lastEditor: user.uid 
                    };
                    
                    // Firestore 저장 (이 순간 모든 기기에 전파됨)
                    await setDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'toons', toonId), toonData, { merge: true });
                    
                    // 스프레드시트 백업
                    await saveToSheet(toonData);
                    
                    setIsEditing(false);
                    setIsSyncing(false);
                } catch (e) {
                    alert("동기화 실패: " + e.message);
                    setIsSyncing(false);
                }
            };

            const handleDelete = async (id) => {
                if (!confirm("이 콘티를 클라우드에서 영구 삭제할까요?")) return;
                const { doc, deleteDoc } = window.FB;
                await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'toons', id));
            };

            const checkPin = () => {
                if (pinInput === pin) setShowPinEntry(false);
                else { alert("PIN이 틀렸습니다."); setPinInput(''); }
            };

            // PIN 잠금 화면
            if (showPinEntry) return (
                <div className="h-screen w-screen flex flex-col items-center justify-center bg-pink-600 text-white p-10">
                    <i data-lucide="shield-check" className="w-12 h-12 mb-6 opacity-50"></i>
                    <h2 className="text-2xl font-black mb-8">보안 PIN 입력</h2>
                    <input 
                        type="password" 
                        value={pinInput} 
                        onChange={(e) => setPinInput(e.target.value)} 
                        onKeyDown={(e) => e.key === 'Enter' && checkPin()}
                        autoFocus
                        className="bg-white/20 border-b-4 border-white text-center text-4xl w-full max-w-[200px] outline-none py-2 rounded-t-xl" 
                    />
                    <button onClick={checkPin} className="mt-10 bg-white text-pink-600 px-12 py-4 rounded-2xl font-black shadow-2xl active:scale-95 transition-all">확인</button>
                    {useEffect(() => { window.lucide && window.lucide.createIcons(); }, [])}
                </div>
            );

            if (loading) return (
                <div className="flex flex-col items-center justify-center h-screen bg-[#FFF5F7]">
                    <div className="spinner"></div>
                    <p className="mt-4 text-pink-500 font-bold tracking-tight">전 기기 데이터 동기화 중...</p>
                </div>
            );

            return (
                <div className={`h-full w-full flex flex-col transition-all duration-300 ${darkMode ? 'dark-mode' : 'bg-[#FFF5F7] text-slate-800'}`}>
                    
                    <header className={`px-6 pt-safe pb-4 flex justify-between items-center border-b transition-colors z-50 ${darkMode ? 'bg-slate-900/90 border-slate-800' : 'bg-white/95 border-pink-100'} backdrop-blur-xl sticky top-0`}>
                        <div className="flex items-center gap-2">
                            {(isEditing || isSettings) && (
                                <button onClick={() => {setIsEditing(false); setIsSettings(false);}} className="p-2 -ml-2 text-pink-500 active:scale-75 transition-transform">
                                    <i data-lucide="chevron-left" className="w-8 h-8"></i>
                                </button>
                            )}
                            <h1 className="text-2xl font-black text-pink-600 tracking-tighter">ToonKit <span className="text-[10px] bg-pink-100 text-pink-500 px-2 py-0.5 rounded-full align-middle ml-1">MASTER</span></h1>
                        </div>
                        <div className="flex items-center gap-3">
                            {!isEditing && !isSettings && (
                                <>
                                    <button onClick={() => setIsSettings(true)} className="p-2 text-slate-400 hover:text-pink-500 transition-colors"><i data-lucide="settings"></i></button>
                                    <button 
                                        onClick={() => {setCurrentToon({id:null, title:'', pages:Array(10).fill(''), status:'Idea'}); setIsEditing(true);}} 
                                        className="bg-pink-500 text-white px-5 py-2.5 rounded-2xl font-black text-xs shadow-lg shadow-pink-200 active:scale-90 transition-all flex items-center gap-2"
                                    >
                                        <i data-lucide="plus" className="w-4 h-4"></i> 새 콘티
                                    </button>
                                </>
                            )}
                            {isEditing && (
                                <button onClick={handleSave} disabled={isSyncing} className={`text-pink-500 font-black text-sm px-4 py-2 ${isSyncing ? 'opacity-30' : ''}`}>
                                    {isSyncing ? '클라우드 동기화 중...' : '저장 완료'}
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container">
                        {isSettings ? (
                            <div className="p-6 space-y-8 fade-in max-w-2xl mx-auto">
                                <section className="space-y-4">
                                    <label className="text-[10px] font-black text-pink-400 tracking-widest ml-1 uppercase">Sync Account (Multi-Device)</label>
                                    <div className={`p-5 rounded-[2rem] border transition-all ${darkMode ? 'dark-card' : 'bg-white border-pink-50 shadow-sm'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-2xl bg-pink-100 flex items-center justify-center text-pink-500 shadow-inner">
                                                    <i data-lucide="cloud"></i>
                                                </div>
                                                <div>
                                                    <p className="font-black text-sm">{user?.isAnonymous ? "임시 동기화 계정" : user?.displayName}</p>
                                                    <p className="text-[10px] opacity-40 font-mono truncate max-w-[200px]">{user?.email || "로그인하여 데이터를 보호하세요"}</p>
                                                </div>
                                            </div>
                                            {user?.isAnonymous ? (
                                                <button onClick={handleGoogleLogin} className="bg-pink-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg">구글 연동</button>
                                            ) : (
                                                <button onClick={handleLogout} className="text-[10px] font-black text-red-400">연동 해제</button>
                                            )}
                                        </div>
                                    </div>
                                    <p className="text-[10px] text-slate-400 px-2 italic">* 구글 로그인을 하면 다른 기기에서도 즉시 데이터가 나타납니다.</p>
                                </section>

                                <section className="space-y-4">
                                    <label className="text-[10px] font-black text-pink-400 tracking-widest ml-1 uppercase">Preferences</label>
                                    <div className={`p-5 rounded-[2.5rem] border space-y-6 ${darkMode ? 'dark-card' : 'bg-white border-pink-50 shadow-sm'}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3"><i data-lucide="lock" className="w-5 h-5 text-pink-300"></i><span className="text-sm font-bold">보안 PIN (4자리)</span></div>
                                            <input 
                                                type="password" 
                                                value={pin} 
                                                maxLength={4}
                                                onChange={(e) => {setPin(e.target.value); localStorage.setItem('toonkit_pin', e.target.value);}} 
                                                className="w-16 bg-slate-50 dark:bg-slate-700 p-2 rounded-lg text-right outline-none text-pink-500 font-black tracking-widest" 
                                                placeholder="OFF" 
                                            />
                                        </div>
                                        <div onClick={() => {const next = !darkMode; setDarkMode(next); localStorage.setItem('toonkit_dark', next);}} className="flex items-center justify-between cursor-pointer group">
                                            <div className="flex items-center gap-3"><i data-lucide={darkMode ? "sun" : "moon"} className="w-5 h-5 text-pink-300 transition-transform group-active:rotate-45"></i><span className="text-sm font-bold">다크 모드</span></div>
                                            <div className={`w-12 h-6 rounded-full transition-all relative ${darkMode ? 'bg-pink-500 shadow-[0_0_10px_rgba(236,72,153,0.4)]' : 'bg-slate-200'}`}>
                                                <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${darkMode ? 'left-7' : 'left-1'}`}></div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        ) : isEditing ? (
                            <div className="p-6 space-y-6 pb-40 fade-in max-w-2xl mx-auto">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-pink-400 ml-2 tracking-widest uppercase">Toon Story Title</label>
                                    <input 
                                        type="text" 
                                        value={currentToon.title} 
                                        onChange={(e) => setCurrentToon({...currentToon, title:e.target.value})} 
                                        placeholder="어떤 이야기를 담을까요?" 
                                        className={`w-full p-6 rounded-[2rem] border-2 text-2xl font-black outline-none transition-all ${darkMode ? 'bg-slate-800 border-slate-700 focus:border-pink-500' : 'bg-white border-pink-50 focus:border-pink-300 shadow-sm'}`} 
                                    />
                                </div>
                                
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black text-pink-400 ml-2 tracking-widest uppercase">Scenario Script (10 Scenes)</label>
                                    {currentToon.pages.map((p, i) => (
                                        <div key={i} className={`p-6 rounded-[2.5rem] border transition-all ${darkMode ? 'dark-card' : 'bg-white border-pink-50 shadow-sm focus-within:border-pink-200'}`}>
                                            <div className="flex items-center gap-3 mb-4">
                                                <span className={`w-8 h-8 rounded-xl flex items-center justify-center font-black text-xs ${i === 0 ? 'bg-pink-500 text-white' : 'bg-pink-50 text-pink-400 dark:bg-slate-700'}`}>{i === 0 ? "Cover" : i}</span>
                                                <span className="text-[10px] font-black opacity-30 uppercase tracking-tighter">{i === 0 ? "핵심 썸네일 & 제목 레이아웃" : `Page ${i} - Scene Details`}</span>
                                            </div>
                                            <textarea 
                                                value={p} 
                                                onChange={(e) => {const n = [...currentToon.pages]; n[i] = e.target.value; setCurrentToon({...currentToon, pages:n});}} 
                                                className="w-full min-h-[140px] bg-transparent outline-none text-base leading-relaxed resize-none font-medium" 
                                                placeholder={i === 0 ? "사람들의 시선을 끌 이미지와 제목을 묘사하세요..." : `${i}페이지의 대사와 연출 의도를 적어주세요.`} 
                                            />
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="fixed bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-inherit via-inherit to-transparent pointer-events-none z-50">
                                    <button 
                                        onClick={handleSave} 
                                        disabled={isSyncing} 
                                        className={`w-full max-w-md mx-auto py-5 rounded-[2.2rem] font-black text-xl shadow-2xl pointer-events-auto active:scale-95 transition-all flex items-center justify-center gap-4 ${isSyncing ? 'bg-slate-400' : 'bg-pink-600 shadow-pink-200'} text-white`}
                                    >
                                        {isSyncing ? <div className="w-6 h-6 border-3 border-white/30 border-t-white rounded-full animate-spin"></div> : <i data-lucide="save" className="w-6 h-6"></i>}
                                        {isSyncing ? "전 기기 동기화 중..." : "모든 기기에 저장"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="p-6 space-y-8 fade-in max-w-2xl mx-auto">
                                <div className="flex items-center justify-between px-1">
                                    <h2 className="text-[10px] font-black text-pink-400 tracking-widest uppercase">Cloud Library <span className="ml-1 opacity-40">{toons.length}</span></h2>
                                    <div className="flex items-center gap-2 text-[10px] font-black text-pink-500 bg-pink-50 dark:bg-pink-900/20 px-3 py-1.5 rounded-full border border-pink-100 dark:border-pink-800">
                                        <div className="w-1.5 h-1.5 bg-pink-500 rounded-full animate-pulse"></div>
                                        Live Sync Active
                                    </div>
                                </div>

                                {toons.length === 0 ? (
                                    <div className="text-center py-40 opacity-20 flex flex-col items-center">
                                        <div className="w-20 h-20 bg-slate-200 dark:bg-slate-800 rounded-[3rem] flex items-center justify-center mb-6">
                                            <i data-lucide="inbox" className="w-10 h-10"></i>
                                        </div>
                                        <p className="text-sm font-black text-slate-500">클라우드에 저장된 콘티가 없습니다</p>
                                    </div>
                                ) : (
                                    <div className="grid gap-5 pb-20">
                                        {toons.map(t => (
                                            <div key={t.id} onClick={() => {setCurrentToon(t); setIsEditing(true);}} className={`group p-8 rounded-[2.5rem] border transition-all active:scale-[0.98] cursor-pointer relative overflow-hidden ${darkMode ? 'dark-card' : 'bg-white border-white shadow-[0_15px_45px_rgba(255,182,193,0.15)]'}`}>
                                                <div className="flex justify-between items-start mb-6">
                                                    <div className="flex-1 pr-6">
                                                        <h3 className="font-black text-xl leading-tight mb-2 truncate group-hover:text-pink-500 transition-colors tracking-tight">{t.title || "제목을 입력해주세요"}</h3>
                                                        <div className="flex items-center gap-3">
                                                            <p className="text-[10px] font-bold text-pink-300 uppercase tracking-tighter">
                                                                <i data-lucide="clock" className="w-3 h-3 inline mr-1 -mt-0.5"></i>
                                                                {t.updatedAt ? new Date(t.updatedAt.seconds * 1000).toLocaleString() : 'Saving...'}
                                                            </p>
                                                            <span className="w-1 h-1 bg-pink-100 rounded-full"></span>
                                                            <p className="text-[10px] font-bold text-slate-300 uppercase tracking-tighter">
                                                                {t.pages.filter(p => p.trim()).length} Scene Written
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={(e) => {e.stopPropagation(); handleDelete(t.id);}} 
                                                        className="p-3 -mr-3 text-slate-100 hover:text-red-400 active:scale-75 transition-all"
                                                    >
                                                        <i data-lucide="trash-2" className="w-6 h-6"></i>
                                                    </button>
                                                </div>
                                                
                                                {/* 진행률 바 */}
                                                <div className="flex gap-1.5 h-2 w-full bg-slate-50 dark:bg-slate-900 rounded-full overflow-hidden">
                                                    {t.pages.map((p, idx) => (
                                                        <div 
                                                            key={idx} 
                                                            className={`flex-1 transition-all duration-700 ${p?.trim() ? 'bg-pink-500 shadow-[0_0_8px_rgba(219,39,119,0.3)]' : 'bg-transparent'}`} 
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {useEffect(() => { 
                        if (window.lucide) window.lucide.createIcons(); 
                    }, [isEditing, isSettings, toons, darkMode, showPinEntry])}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>