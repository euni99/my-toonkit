<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Master Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100dvh; width: 100vw; display: flex; flex-direction: column; }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); }
        ::-webkit-scrollbar { display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase & Google API -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // 구글 클라우드 설정 정보 (작가님의 정보로 교체 필요)
        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';   
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const SPREADSHEET_ID = '1d7LW-LcV-Qiukq5F9LzvJB0sDYVhbtLQ5IicmwhiUHk'; // 선택 사항

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const iconNode = document.createElement('i');
                    iconNode.setAttribute('data-lucide', name);
                    iconRef.current.appendChild(iconNode);
                    window.lucide.createIcons({ nameAttr: 'data-lucide' });
                }
            }, [name]);
            return <span ref={iconRef} className={className + " inline-flex items-center justify-center"}></span>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [gapiInited, setGapiInited] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [toons, setToons] = useState([]);
            const [currentToon, setCurrentToon] = useState({ title: '', pages: Array(10).fill('') });
            const [isEditing, setIsEditing] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [googleToken, setGoogleToken] = useState(null);

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-master';

            // 1. Google API & Firebase Auth 초기화
            useEffect(() => {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth Fail", e); }
                };

                const initGapi = () => {
                    gapi.load('client', async () => {
                        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest'] });
                        setGapiInited(true);
                    });
                };

                initAuth();
                initGapi();

                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u && localStorage.getItem('toonkit_verified') === 'true') setIsLoggedIn(true);
                    setIsLoading(false);
                });
                return () => unsub();
            }, []);

            // 2. Firestore 실시간 감시
            useEffect(() => {
                if (!isLoggedIn || !user) return;
                const db = firebase.firestore();
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('master_toons');
                
                return col.onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setToons(data.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)));
                }, err => console.error("Sync Error", err));
            }, [isLoggedIn, user]);

            // 3. 구글 시트 연동 함수
            const syncToGoogleSheet = async (toonData) => {
                if (!googleToken) return;
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'A1:L1',
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [[
                                new Date().toLocaleString(),
                                toonData.title,
                                ...toonData.pages
                            ]]
                        }
                    });
                    console.log("Sheet Updated", response);
                } catch (err) {
                    console.error("Sheet Sync Error", err);
                }
            };

            const handleGoogleLogin = () => {
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return;
                        setGoogleToken(resp.access_token);
                        setIsLoggedIn(true);
                        localStorage.setItem('toonkit_verified', 'true');
                    },
                });
                tokenClient.requestAccessToken();
            };

            const handleSave = async () => {
                if (!currentToon.title.trim() || !user) return;
                setIsSyncing(true);
                const db = firebase.firestore();
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('master_toons');
                
                const payload = { ...currentToon, updatedAt: new Date().toISOString() };

                try {
                    if (currentToon.id) {
                        await col.doc(currentToon.id).set(payload, { merge: true });
                    } else {
                        await col.add({ ...payload, createdAt: new Date().toISOString() });
                    }
                    // 구글 시트가 설정되어 있다면 동기화 시도
                    if (googleToken && SPREADSHEET_ID) await syncToGoogleSheet(payload);
                    
                    setIsEditing(false);
                    setCurrentToon({ title: '', pages: Array(10).fill('') });
                } catch (e) { console.error("Save Error", e); }
                setIsSyncing(false);
            };

            if (isLoading) return <div className="fixed inset-0 flex items-center justify-center bg-white"><div className="spinner"></div></div>;

            if (!isLoggedIn) return (
                <div className="flex items-center justify-center min-h-screen bg-pink-50 p-6">
                    <div className="w-full max-w-sm p-10 glass-card rounded-[3rem] shadow-2xl text-center border-white">
                        <div className="mb-6 inline-flex p-5 bg-pink-500 rounded-3xl text-white shadow-lg"><Icon name="shield-check" className="w-8 h-8" /></div>
                        <h1 className="text-4xl font-black mb-2 text-pink-600 italic tracking-tighter">ToonKit Cloud</h1>
                        <p className="text-xs text-slate-400 mb-10 font-bold uppercase tracking-widest">Google & Sheet Integration</p>
                        <button 
                            onClick={handleGoogleLogin}
                            className="w-full py-5 bg-white border-2 border-pink-100 rounded-3xl font-black text-slate-700 flex items-center justify-center gap-3 hover:bg-pink-50 active:scale-95 transition-all shadow-sm"
                        >
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                            구글 계정으로 시작하기
                        </button>
                        <p className="mt-6 text-[10px] text-slate-300 font-medium leading-relaxed">구글 로그인 시 스프레드시트에<br/>자동으로 콘티가 백업됩니다.</p>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-[#FFF5F7]">
                    <header className="px-6 pt-12 pb-6 bg-white border-b border-pink-50 flex justify-between items-center shadow-sm">
                        <div className="flex flex-col">
                            <h1 className="text-2xl font-black text-pink-600 italic tracking-tighter">ToonKit</h1>
                            <div className="flex items-center gap-2">
                                <span className="text-[9px] font-black text-green-400 uppercase tracking-widest flex items-center gap-1">● Online</span>
                                {googleToken && <span className="text-[9px] font-black text-blue-400 uppercase tracking-widest flex items-center gap-1">● Sheet Linked</span>}
                            </div>
                        </div>
                        <button onClick={() => { setCurrentToon({ title: '', pages: Array(10).fill('') }); setIsEditing(true); }} className="px-5 py-2.5 bg-pink-500 text-white rounded-2xl font-black text-xs shadow-lg active:scale-90 transition-transform">+ NEW TOON</button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-6 pb-32">
                        {isEditing ? (
                            <div className="max-w-xl mx-auto space-y-4 animate-in fade-in slide-in-from-bottom-4">
                                <div className="flex items-center gap-2 mb-4">
                                    <button onClick={() => setIsEditing(false)} className="p-2 text-pink-500"><Icon name="arrow-left" /></button>
                                    <input type="text" value={currentToon.title} onChange={e => setCurrentToon({...currentToon, title: e.target.value})} placeholder="에피소드 제목" className="flex-1 bg-white p-4 rounded-2xl border-none font-bold text-lg shadow-inner outline-none focus:ring-2 ring-pink-100" />
                                </div>
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="relative">
                                        <span className="absolute left-6 top-4 text-[10px] font-black text-pink-200 tracking-tighter uppercase">{i === 0 ? "Cover" : `Page ${i + 1}`}</span>
                                        <textarea value={p} onChange={e => {
                                            const n = [...currentToon.pages]; n[i] = e.target.value;
                                            setCurrentToon({...currentToon, pages: n});
                                        }} placeholder="장면 묘사 및 대사..." className="w-full p-6 pt-12 rounded-[2.5rem] bg-white border-none shadow-sm min-h-[120px] outline-none font-medium focus:ring-4 ring-pink-50 transition-all resize-none" />
                                    </div>
                                ))}
                                <button onClick={handleSave} disabled={isSyncing} className="fixed bottom-10 left-6 right-6 max-w-md mx-auto py-5 bg-pink-600 text-white rounded-[2.5rem] font-black shadow-2xl flex items-center justify-center gap-3 active:scale-95 disabled:opacity-50">
                                    {isSyncing ? <div className="spinner w-5 h-5 border-2 border-white border-t-transparent"></div> : <Icon name="cloud-upload" />}
                                    {isSyncing ? "데이터 동기화 중..." : "클라우드 & 시트 동시 저장"}
                                </button>
                            </div>
                        ) : (
                            <div className="max-w-xl mx-auto grid gap-4">
                                {toons.length === 0 ? (
                                    <div className="text-center py-40 opacity-10 font-bold"><Icon name="layout" className="w-20 h-20 mx-auto mb-4" /><p>보관함이 비어있습니다.</p></div>
                                ) : toons.map(t => (
                                    <div key={t.id} onClick={() => { setCurrentToon(t); setIsEditing(true); }} className="p-7 bg-white rounded-[2.8rem] shadow-sm flex justify-between items-center active:scale-[0.98] transition-all border-2 border-transparent hover:border-pink-100 cursor-pointer group">
                                        <div className="flex-1 pr-4 truncate">
                                            <h3 className="font-bold text-xl text-slate-800 truncate group-hover:text-pink-500 transition-colors">{t.title || "무제"}</h3>
                                            <div className="flex items-center gap-3 mt-2">
                                                <div className="flex gap-1">
                                                    {t.pages.map((p,idx) => (
                                                        <div key={idx} className={`w-1.5 h-1.5 rounded-full ${p && p.trim() ? 'bg-pink-400' : 'bg-pink-50'}`}></div>
                                                    ))}
                                                </div>
                                                <span className="text-[9px] text-slate-300 font-bold uppercase tracking-tighter italic">{new Date(t.updatedAt).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                        <Icon name="chevron-right" className="text-pink-100 group-hover:text-pink-300 transition-all" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>