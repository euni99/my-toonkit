<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Master Access</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100dvh; width: 100vw; display: flex; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); }
        ::-webkit-scrollbar { display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
    <div id="root">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #db2777; font-weight: 800;">보안 연결 중...</p>
        </div>
    </div>

    <!-- Firebase Compatibility SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [pin, setPin] = useState("");
            const [toons, setToons] = useState([]);
            const [currentToon, setCurrentToon] = useState({ title: '', status: 'Idea', pages: Array(10).fill('') });
            const [isEditing, setIsEditing] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-master-shared';
            const MASTER_PIN = "0224"; // 작가님이 설정하신 고유 PIN 번호

            useEffect(() => {
                const initFirebase = async () => {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    const auth = firebase.auth();
                    
                    try {
                        // 익명 인증으로 Firestore 접근 권한 획득 (서버 보안 규칙 통과용)
                        await auth.signInAnonymously();
                        
                        // 브라우저 로컬 스토리지에 인증 정보가 있으면 즉시 로그인 상태로 전환
                        if (localStorage.getItem('toonkit_auth') === 'verified') {
                            setIsLoggedIn(true);
                        }
                        setIsLoading(false);
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        setIsLoading(false);
                    }
                };
                initFirebase();
            }, []);

            // Firestore 실시간 동기화: 데이터가 변경되면 즉시 UI 업데이트
            useEffect(() => {
                if (!isLoggedIn) return;
                
                const db = firebase.firestore();
                // 작가님 전용 단일 클라우드 경로
                const path = `artifacts/${appId}/public/data/master_toons`;
                
                const unsub = db.collection(path).onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // 최신 업데이트순 정렬
                    setToons(data.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)));
                    // Lucide 아이콘 새로고침
                    if (window.lucide) window.lucide.createIcons();
                }, err => {
                    console.error("Cloud Sync Error:", err);
                });

                return () => unsub();
            }, [isLoggedIn]);

            const handlePinInput = (val) => {
                setPin(val);
                if (val === MASTER_PIN) {
                    localStorage.setItem('toonkit_auth', 'verified');
                    setIsLoggedIn(true);
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('toonkit_auth');
                setIsLoggedIn(false);
                setPin("");
            };

            const handleSave = async () => {
                if (!currentToon.title.trim()) return;
                setIsSyncing(true);
                const db = firebase.firestore();
                const path = `artifacts/${appId}/public/data/master_toons`;
                const payload = { 
                    ...currentToon, 
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (currentToon.id) {
                        // 기존 콘티 수정
                        await db.doc(`${path}/${currentToon.id}`).update(payload);
                    } else {
                        // 새 콘티 추가
                        await db.collection(path).add({ ...payload, createdAt: new Date().toISOString() });
                    }
                    setIsEditing(false);
                    setCurrentToon({ title: '', status: 'Idea', pages: Array(10).fill('') });
                } catch (e) { 
                    console.error("Save Error:", e);
                }
                setIsSyncing(false);
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation(); // 카드 클릭 이벤트 방지
                if(!confirm("이 콘티를 클라우드에서 영구 삭제할까요?")) return;
                const db = firebase.firestore();
                try {
                    await db.doc(`artifacts/${appId}/public/data/master_toons/${id}`).delete();
                } catch (e) {
                    console.error("Delete Error:", e);
                }
            };

            if (isLoading) return (
                <div className="fixed inset-0 flex items-center justify-center bg-[#FFF5F7]">
                    <div className="spinner"></div>
                </div>
            );

            // PIN 번호 로그인 화면
            if (!isLoggedIn) return (
                <div className="flex items-center justify-center min-h-screen p-6 bg-pink-50 font-sans">
                    <div className="w-full max-w-sm p-10 glass-card rounded-[3rem] shadow-2xl text-center border-white relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-pink-500"></div>
                        <div className="mb-6 inline-flex p-5 bg-pink-500 rounded-3xl text-white shadow-lg rotate-3"><i data-lucide="lock" className="w-8 h-8"></i></div>
                        <h1 className="text-4xl font-black mb-2 text-pink-600 italic tracking-tighter">ToonKit</h1>
                        <p className="text-[11px] text-slate-400 mb-10 font-bold uppercase tracking-widest">Master Access Only</p>
                        
                        <div className="space-y-6">
                            <div className="relative">
                                <input 
                                    type="password" 
                                    value={pin} 
                                    onChange={e => handlePinInput(e.target.value)} 
                                    placeholder="••••" 
                                    className="w-full p-6 bg-white border-2 border-pink-100 rounded-3xl font-black text-center text-4xl outline-none focus:border-pink-400 tracking-[0.3em] transition-all shadow-inner" 
                                    maxLength={4}
                                    autoFocus
                                />
                                {pin.length > 0 && pin !== MASTER_PIN && pin.length === 4 && (
                                    <p className="text-red-400 text-[10px] mt-2 font-bold animate-bounce text-center">PIN 번호가 일치하지 않습니다.</p>
                                )}
                            </div>
                            <p className="text-[10px] text-slate-300 font-medium">작가 전용 PIN 번호를 입력하면 보관함이 열립니다.</p>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-[#FFF5F7]">
                    {/* 메인 헤더 */}
                    <header className="px-6 pt-12 pb-6 bg-white border-b border-pink-50 flex justify-between items-center shadow-sm">
                        <div className="flex flex-col">
                            <h1 className="text-2xl font-black text-pink-600 italic tracking-tighter">ToonKit</h1>
                            <span className="text-[9px] font-black text-pink-300 uppercase tracking-widest flex items-center gap-1">
                                <span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Cloud Connected
                            </span>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={handleLogout} className="p-2 text-slate-300 active:scale-75 transition-all"><i data-lucide="log-out" className="w-5 h-5"></i></button>
                             <button onClick={() => { setCurrentToon({ title: '', status: 'Idea', pages: Array(10).fill('') }); setIsEditing(true); }} className="px-5 py-2.5 bg-pink-500 text-white rounded-2xl font-black text-xs shadow-lg active:scale-90 transition-transform tracking-tight">+ NEW TOON</button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-6 pb-32">
                        {isEditing ? (
                            /* 콘티 작성/수정 모드 */
                            <div className="max-w-xl mx-auto space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                <div className="flex items-center gap-2 mb-4">
                                    <button onClick={() => setIsEditing(false)} className="p-2 text-pink-500 active:scale-90 transition-all"><i data-lucide="arrow-left"></i></button>
                                    <input type="text" value={currentToon.title} onChange={e => setCurrentToon({...currentToon, title: e.target.value})} placeholder="에피소드 제목을 입력하세요" className="flex-1 bg-white p-4 rounded-2xl border-none font-bold text-lg shadow-inner outline-none focus:ring-2 ring-pink-100" />
                                </div>
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="relative group">
                                        <span className="absolute left-6 top-4 text-[10px] font-black text-pink-200 tracking-tighter uppercase">{i === 0 ? "Cover Page" : `Page ${i + 1}`}</span>
                                        <textarea value={p} onChange={e => {
                                            const n = [...currentToon.pages]; n[i] = e.target.value;
                                            setCurrentToon({...currentToon, pages: n});
                                        }} placeholder={i === 0 ? "이 에피소드의 대표 장면을 묘사해주세요." : `${i+1}페이지의 대사와 연출을 기록하세요.`} className="w-full p-6 pt-12 rounded-[2.5rem] bg-white border-none shadow-sm min-h-[140px] outline-none font-medium focus:ring-4 ring-pink-50 transition-all resize-none placeholder:text-slate-200" />
                                    </div>
                                ))}
                                <div className="h-24"></div>
                                <button onClick={handleSave} className="fixed bottom-10 left-6 right-6 max-w-md mx-auto py-5 bg-pink-600 text-white rounded-[2.5rem] font-black shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3">
                                    {isSyncing ? <div className="spinner w-5 h-5 border-2 border-white border-t-transparent"></div> : <i data-lucide="cloud-upload" className="w-5 h-5"></i>}
                                    {isSyncing ? "저장 중..." : "클라우드 보관함에 동기화"}
                                </button>
                            </div>
                        ) : (
                            /* 목록 모드 */
                            <div className="max-w-xl mx-auto grid gap-4">
                                {toons.length === 0 ? (
                                    <div className="text-center py-40 opacity-10">
                                        <i data-lucide="layout" className="w-20 h-20 mx-auto mb-4"></i>
                                        <p className="font-bold">작성된 콘티가 없습니다.<br/>새로운 아이디어를 추가해보세요!</p>
                                    </div>
                                ) : toons.map(t => (
                                    <div key={t.id} onClick={() => { setCurrentToon(t); setIsEditing(true); }} className="p-7 bg-white rounded-[2.8rem] shadow-sm flex justify-between items-center active:scale-[0.98] transition-all border-2 border-transparent hover:border-pink-100 group cursor-pointer">
                                        <div className="flex-1 overflow-hidden pr-4">
                                            <h3 className="font-bold text-xl text-slate-800 tracking-tight group-hover:text-pink-500 transition-colors truncate">{t.title || "무제"}</h3>
                                            <div className="flex items-center gap-3 mt-3">
                                                {/* 페이지 진행도 인디케이터 */}
                                                <div className="flex gap-1">
                                                    {t.pages.map((p,idx) => (
                                                        <div key={idx} className={`w-1.5 h-1.5 rounded-full transition-colors ${p.trim() ? 'bg-pink-400' : 'bg-pink-50'}`}></div>
                                                    ))}
                                                </div>
                                                <span className="text-[10px] text-slate-100">|</span>
                                                <p className="text-[9px] text-slate-300 font-bold uppercase tracking-tighter">Updated: {new Date(t.updatedAt).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                        <button onClick={(e) => handleDelete(e, t.id)} className="p-3 text-slate-100 hover:text-red-400 active:scale-90 transition-all"><i data-lucide="trash-2" className="w-5 h-5"></i></button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // 아이콘 초기화 로직
        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        window.addEventListener('load', refreshIcons);
        document.addEventListener('click', () => setTimeout(refreshIcons, 50));
    </script>
</body>
</html>