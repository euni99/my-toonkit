<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ToonKit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100%; width: 100%; }
        .spinner { width: 24px; height: 24px; border: 3px solid #fbcfe8; border-top-color: #db2777; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-safe { padding-top: max(1.25rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1.5rem, var(--safe-bottom)); }
        .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .toon-card-completed { background-color: #f1f5f9 !important; opacity: 0.7; filter: grayscale(0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const App = () => {
            // 로컬 데이터 로드 우선
            const [toons, setToons] = useState(() => {
                const saved = localStorage.getItem('toonkit_local_db_v2');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), completed: false });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [spreadsheetId, setSpreadsheetId] = useState(localStorage.getItem('toonkit_sheet_id') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const tokenClient = useRef(null);

            const refreshIcons = useCallback(() => {
                if (window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                localStorage.setItem('toonkit_local_db_v2', JSON.stringify(toons));
                refreshIcons();
            }, [toons, refreshIcons]);

            // 구글 라이브러리 초기화
            useEffect(() => {
                const startGapi = () => {
                    window.gapi.load('client', async () => {
                        try {
                            await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                            console.log("GAPI 초기화 완료");
                        } catch (e) { console.error("GAPI 초기화 에러", e); }
                    });
                };

                const startGis = () => {
                    tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: '', // 나중에 동적으로 설정
                    });
                };

                if (window.gapi) startGapi();
                if (window.google) startGis();
            }, []);

            const handleLogin = () => {
                if (!tokenClient.current) return;
                
                tokenClient.current.callback = async (resp) => {
                    if (resp.error) {
                        setErrorMsg(`로그인 오류: ${resp.error}`);
                        return;
                    }
                    setIsLoggedIn(true);
                    setErrorMsg('');
                    if (spreadsheetId) syncWithSheets(toons);
                };

                if (window.gapi.client.getToken() === null) {
                    tokenClient.current.requestAccessToken({ prompt: 'consent' });
                } else {
                    tokenClient.current.requestAccessToken({ prompt: '' });
                }
            };

            const saveToon = async () => {
                if (!currentToon.title.trim()) {
                    alert("제목을 입력해주세요!");
                    return;
                }
                
                const toonWithId = currentToon.id ? currentToon : { 
                    ...currentToon, 
                    id: Date.now().toString(),
                    updatedAt: new Date().toISOString()
                };
                
                const newList = currentToon.id 
                    ? toons.map(t => t.id === currentToon.id ? toonWithId : t)
                    : [toonWithId, ...toons];
                
                // 로컬 저장 (무조건 수행)
                setToons(newList);
                setIsEditing(false);

                // 구글 시트 동기화 시도
                if (isLoggedIn && spreadsheetId) {
                    syncWithSheets(newList);
                } else if (spreadsheetId && !isLoggedIn) {
                    setErrorMsg('로컬에 저장됨. 구글 로그인을 하면 시트와 동기화됩니다.');
                }
            };

            const syncWithSheets = async (dataList) => {
                if (!spreadsheetId || !isLoggedIn) return;
                setIsSyncing(true);
                setErrorMsg('');
                try {
                    const response = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId });
                    const sheetName = response.result.sheets[0].properties.title;
                    const values = dataList.map(t => [t.title, ...t.pages, t.completed ? 'TRUE' : 'FALSE', t.id]);
                    
                    await window.gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId,
                        range: `${sheetName}!A1`,
                        valueInputOption: 'RAW',
                        resource: { 
                            values: [['제목', 'P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8', 'P9', 'P10', '완료여부', 'ID'], ...values] 
                        }
                    });
                    console.log("시트 동기화 성공");
                } catch (e) {
                    console.error("시트 에러", e);
                    setErrorMsg('시트 저장 실패: 시트 ID가 정확한지, 공유 설정이 [편집자]인지 확인하세요.');
                    // 권한 만료 시 로그인 해제 처리
                    if (e.status === 401 || e.status === 403) setIsLoggedIn(false);
                } finally { setIsSyncing(false); }
            };

            const deleteToon = (id, e) => {
                e.stopPropagation();
                if (window.confirm("정말 삭제하시겠습니까? 로컬과 시트 모두에서 제거됩니다.")) {
                    const newList = toons.filter(t => t.id !== id);
                    setToons(newList);
                    if (isLoggedIn && spreadsheetId) syncWithSheets(newList);
                }
            };

            return (
                <div className="h-full w-full flex flex-col overflow-hidden">
                    <header className="flex-none px-6 pt-safe pb-4 flex justify-between items-center bg-white border-b border-pink-50 shadow-sm z-20">
                        <div className="flex items-center gap-3">
                            {isEditing ? (
                                <button onClick={() => setIsEditing(false)} className="text-pink-400 p-1 active:scale-90 transition-transform"><i data-lucide="chevron-left" style={{width: 32, height: 32}}></i></button>
                            ) : (
                                <div className="w-10 h-10 bg-pink-500 rounded-2xl flex items-center justify-center text-white shadow-lg"><i data-lucide="sparkles"></i></div>
                            )}
                            <h1 className="text-2xl font-black text-pink-600 tracking-tight">ToonKit</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setShowSettings(!showSettings)} className={`p-2 transition-colors ${spreadsheetId && isLoggedIn ? 'text-pink-500' : 'text-pink-200'}`}><i data-lucide="cloud"></i></button>
                            {!isEditing && (
                                <button onClick={() => { setCurrentToon({id:null, title:'', pages:Array(10).fill(''), completed:false}); setIsEditing(true); }} className="px-4 py-2 bg-pink-500 text-white rounded-xl font-bold text-sm active:scale-95 transition-all">새 콘티</button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container px-6 py-6 pb-40 max-w-2xl mx-auto w-full">
                        {showSettings && (
                            <div className="mb-8 p-6 bg-white rounded-3xl border-2 border-pink-100 shadow-sm animate-in slide-in-from-top duration-300">
                                <h2 className="font-black text-pink-500 mb-4 text-xs tracking-widest uppercase text-center">Sync Control</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 ml-1 mb-1 block uppercase tracking-wider">Spreadsheet ID</label>
                                        <input 
                                            type="text" value={spreadsheetId} 
                                            onChange={(e) => { 
                                                const val = e.target.value.trim();
                                                setSpreadsheetId(val); 
                                                localStorage.setItem('toonkit_sheet_id', val); 
                                            }}
                                            placeholder="구글 시트 주소창의 ID 입력" 
                                            className="w-full p-4 bg-pink-50 rounded-2xl text-sm outline-none border-2 border-transparent focus:border-pink-200 transition-all"
                                        />
                                    </div>
                                    <button 
                                        onClick={handleLogin} 
                                        className={`w-full py-4 rounded-2xl font-black text-sm border-2 transition-all flex items-center justify-center gap-2 ${isLoggedIn ? 'bg-green-50 text-green-600 border-green-100' : 'bg-white border-pink-500 text-pink-500'}`}
                                    >
                                        {isLoggedIn ? <><i data-lucide="check-circle" style={{width:16, height:16}}></i> 연동 완료</> : "구글 계정 연결하기"}
                                    </button>
                                </div>
                                {errorMsg && <p className="mt-4 text-[11px] text-red-500 font-bold text-center bg-red-50 p-3 rounded-xl leading-relaxed">⚠️ {errorMsg}</p>}
                                <div className="mt-4 p-4 bg-slate-50 rounded-2xl text-[10px] text-slate-400 leading-relaxed">
                                    데이터는 우선 작가님 폰(로컬)에 저장됩니다.<br/>
                                    시트 연동을 하려면 시트의 공유 설정을 <b>[편집자]</b>로 열어주세요.
                                </div>
                            </div>
                        )}

                        {isEditing ? (
                            <div className="space-y-6">
                                <input type="text" value={currentToon.title} onChange={(e) => setCurrentToon({...currentToon, title: e.target.value})} placeholder="에피소드 제목" className="w-full p-6 rounded-3xl border-2 border-pink-50 bg-white text-xl font-black focus:border-pink-300 outline-none shadow-sm transition-all" />
                                <div className="space-y-4">
                                    {currentToon.pages.map((page, idx) => (
                                        <div key={idx} className="p-6 bg-white rounded-3xl border-2 border-white shadow-sm">
                                            <span className="text-[10px] font-black text-pink-300 uppercase block mb-2">{idx === 0 ? 'COVER (표지)' : `PAGE ${idx + 1}`}</span>
                                            <textarea value={page} onChange={(e) => { const p = [...currentToon.pages]; p[idx] = e.target.value; setCurrentToon({...currentToon, pages: p}); }} className="w-full bg-transparent resize-none outline-none text-lg min-h-[120px] leading-relaxed" placeholder="연출과 대사를 입력하세요..." />
                                        </div>
                                    ))}
                                </div>
                                <div className="fixed bottom-0 left-0 right-0 p-8 pb-safe bg-gradient-to-t from-[#FFF5F7] via-[#FFF5F7] to-transparent z-30">
                                    <button onClick={saveToon} className="w-full max-w-lg mx-auto p-6 bg-pink-600 text-white rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3">
                                        {isSyncing ? <div className="spinner" style={{borderTopColor:'#fff'}}></div> : "보관함 저장"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {toons.length === 0 ? (
                                    <div className="py-20 text-center opacity-20"><i data-lucide="layout" style={{width: 48, height: 48, margin: '0 auto 16px'}}></i><p className="font-bold">아직 작성한 콘티가 없습니다</p></div>
                                ) : (
                                    toons.map((toon) => (
                                        <div key={toon.id} onClick={() => { setCurrentToon(toon); setIsEditing(true); }} className={`group relative p-6 rounded-[2.5rem] border-2 shadow-md active:scale-[0.98] transition-all cursor-pointer ${toon.completed ? 'toon-card-completed border-slate-200' : 'bg-white border-white'}`}>
                                            <div className="flex justify-between items-start mb-4 pr-10">
                                                <h3 className={`font-black text-lg break-all ${toon.completed ? 'line-through text-slate-400' : 'text-slate-800'}`}>{toon.title}</h3>
                                                <button onClick={(e) => deleteToon(toon.id, e)} className="absolute top-6 right-6 p-2 text-pink-100 hover:text-red-400 transition-colors">
                                                    <i data-lucide="trash-2" style={{width: 20, height: 20}}></i>
                                                </button>
                                            </div>
                                            <div className="flex gap-1.5 h-2">
                                                {toon.pages.map((p, i) => (
                                                    <div key={i} className={`flex-1 rounded-full transition-all duration-500 ${p.trim() ? (toon.completed ? 'bg-slate-400' : 'bg-pink-500') : 'bg-pink-50'}`} />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>