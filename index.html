<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Cloud Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <!-- Google APIs -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100%; width: 100%; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-safe { padding-top: max(1.25rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1.5rem, var(--safe-bottom)); }
        .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; transition: all 0.2s; }
        .pin-dot.active { background-color: #db2777; transform: scale(1.2); }
        .pin-dot.inactive { background-color: #fce7f3; border: 1px solid #fbcfe8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Babel script block for React/JSX support -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // Configuration
        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // Firebase values provided by environment
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-default';

        const App = () => {
            const [toons, setToons] = useState([]);
            const [user, setUser] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), completed: false });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [rawSheetInput, setRawSheetInput] = useState(localStorage.getItem('toonkit_sheet_raw') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [savedPin, setSavedPin] = useState(localStorage.getItem('toonkit_pin') || '');
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [isSettingPin, setIsSettingPin] = useState(false);
            const [loading, setLoading] = useState(true);

            const tokenClient = useRef(null);

            // 1. Firebase Authentication
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Firebase Auth Error:", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Firestore Real-time Data Sync
            useEffect(() => {
                if (!user) return;

                const q = collection(db, 'artifacts', appId, 'public', 'data', 'toons');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    setToons(data);
                    setLoading(false);
                    if (window.lucide) window.lucide.createIcons();
                }, (err) => {
                    console.error("Firestore Listen Error:", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // 3. Google API Init
            useEffect(() => {
                const initGapi = async () => {
                    try {
                        await new Promise(resolve => window.gapi.load('client', resolve));
                        await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                        const savedToken = localStorage.getItem('google_auth_token');
                        if (savedToken) {
                            window.gapi.client.setToken(JSON.parse(savedToken));
                            setIsLoggedIn(true);
                        }
                    } catch (e) { console.error("GAPI Init Error:", e); }
                };

                const initGis = () => {
                    tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: async (resp) => {
                            if (resp.error) return;
                            localStorage.setItem('google_auth_token', JSON.stringify(resp));
                            setIsLoggedIn(true);
                        },
                    });
                };

                const checkApis = setInterval(() => {
                    if (window.gapi && window.google) {
                        initGapi();
                        initGis();
                        clearInterval(checkApis);
                    }
                }, 500);

                return () => clearInterval(checkApis);
            }, []);

            const extractSheetId = (input) => {
                if (!input) return '';
                if (input.includes('/d/')) {
                    const parts = input.split('/d/');
                    return parts[1] ? parts[1].split('/')[0] : input;
                }
                return input.trim();
            };

            const syncToSheets = async (targetData) => {
                const sId = extractSheetId(rawSheetInput);
                if (!sId || !isLoggedIn || !window.gapi?.client?.sheets) return;
                
                try {
                    const response = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId: sId });
                    const targetSheetName = response.result.sheets[0].properties.title;
                    const rows = targetData.map(t => [
                        t.title, ...t.pages, t.completed ? "완료" : "진행중", t.id, new Date().toLocaleString()
                    ]);
                    const header = ["제목", "P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8", "P9", "P10", "상태", "고유ID", "마지막동기화"];

                    await window.gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: sId, 
                        range: `'${targetSheetName}'!A1`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [header, ...rows] }
                    });
                } catch (err) { console.error("Sheet Sync Error:", err); }
            };

            const saveToon = async () => {
                if (!user || !currentToon.title.trim()) return;
                
                setIsSyncing(true);
                const toonId = currentToon.id || Date.now().toString();
                const toonData = {
                    title: currentToon.title,
                    pages: currentToon.pages,
                    completed: currentToon.completed,
                    updatedAt: serverTimestamp()
                };

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'toons', toonId);
                    await setDoc(docRef, toonData, { merge: true });

                    if (isLoggedIn && rawSheetInput) {
                        const updatedList = toons.map(t => t.id === toonId ? { ...t, ...toonData } : t);
                        if (!currentToon.id) updatedList.unshift({ id: toonId, ...toonData });
                        await syncToSheets(updatedList);
                    }

                    setIsEditing(false);
                    setErrorMsg("");
                } catch (err) {
                    console.error("Save Error:", err);
                    setErrorMsg("저장 실패. 네트워크를 확인하세요.");
                } finally {
                    setIsSyncing(false);
                }
            };

            const deleteToon = async (id) => {
                if (!user || !confirm("정말로 삭제할까요?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'toons', id));
                } catch (e) { console.error(e); }
            };

            const handlePinPress = (num) => {
                const newPin = pinInput + num;
                if (newPin.length > 4) return;
                setPinInput(newPin);
                if (newPin.length === 4) {
                    if (isSettingPin) {
                        localStorage.setItem('toonkit_pin', newPin);
                        setSavedPin(newPin);
                        setIsSettingPin(false);
                        setIsUnlocked(true);
                        setPinInput('');
                    } else if (newPin === savedPin) {
                        setIsUnlocked(true);
                        setPinInput('');
                    } else {
                        setErrorMsg("PIN 오류");
                        setTimeout(() => { setPinInput(''); setErrorMsg(''); }, 500);
                    }
                }
            };

            if (loading && user) {
                return <div className="h-full w-full flex items-center justify-center bg-[#FFF5F7]"><div className="spinner"></div></div>;
            }

            if ((savedPin && !isUnlocked) || isSettingPin) {
                return (
                    <div className="h-full w-full flex flex-col items-center justify-center bg-[#FFF5F7] px-10 fixed inset-0 z-[100]">
                        <div className="mb-10 text-center">
                            <div className="w-16 h-16 bg-pink-500 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-xl">
                                <i data-lucide={isSettingPin ? "shield-check" : "lock"}></i>
                            </div>
                            <h2 className="text-xl font-black text-slate-800">{isSettingPin ? "PIN 번호 설정" : "잠금해제"}</h2>
                        </div>
                        <div className="flex gap-4 mb-12">
                            {[0,1,2,3].map(i => <div key={i} className={`pin-dot ${pinInput.length > i ? 'active' : 'inactive'}`}></div>)}
                        </div>
                        <div className="grid grid-cols-3 gap-6 w-full max-w-[280px]">
                            {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={() => handlePinPress(n.toString())} className="h-16 w-16 rounded-full bg-white text-xl font-bold text-slate-700 shadow-sm active:bg-pink-100">{n}</button>)}
                            <div className="h-16 w-16"></div>
                            <button onClick={() => handlePinPress('0')} className="h-16 w-16 rounded-full bg-white text-xl font-bold text-slate-700 shadow-sm active:bg-pink-100">0</button>
                            <button onClick={() => setPinInput(pinInput.slice(0, -1))} className="h-16 w-16 rounded-full flex items-center justify-center text-slate-300"><i data-lucide="delete"></i></button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full w-full flex flex-col bg-[#FFF5F7]">
                    <header className="px-6 pt-safe pb-4 flex justify-between items-center bg-white border-b border-pink-100 shadow-sm z-30">
                        <div className="flex items-center gap-2">
                            {isEditing && <button onClick={() => setIsEditing(false)} className="mr-2 text-pink-500 border-none bg-transparent cursor-pointer"><i data-lucide="arrow-left"></i></button>}
                            <h1 className="text-xl font-black text-pink-600">ToonKit Cloud</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full border-none cursor-pointer transition-colors ${isLoggedIn ? 'text-pink-600 bg-pink-50' : 'text-slate-300'}`}><i data-lucide="settings"></i></button>
                            {!isEditing && <button onClick={() => {setCurrentToon({id:null, title:'', pages:Array(10).fill(''), completed:false}); setIsEditing(true);}} className="bg-pink-500 text-white px-4 py-2 rounded-xl font-bold text-sm border-none shadow-md active:scale-95">새 콘티</button>}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container px-6 py-4">
                        {showSettings && (
                            <div className="mb-6 p-6 bg-white rounded-3xl border-2 border-pink-100 shadow-xl z-50 relative">
                                <p className="text-[10px] font-black text-pink-400 uppercase mb-3 text-center tracking-widest">Settings</p>
                                <button onClick={() => window.google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID, scope:SCOPES, callback: (r) => {localStorage.setItem('google_auth_token', JSON.stringify(r)); setIsLoggedIn(true);}}).requestAccessToken()} className={`w-full py-4 rounded-2xl font-bold text-sm mb-3 flex items-center justify-center gap-2 ${isLoggedIn ? 'bg-green-50 text-green-600' : 'bg-pink-50 text-pink-600'}`}>
                                    <i data-lucide={isLoggedIn ? "check-circle" : "log-in"}></i>
                                    {isLoggedIn ? "구글 연동됨" : "구글 시트 연동"}
                                </button>
                                <input type="text" value={rawSheetInput} onChange={(e) => {setRawSheetInput(e.target.value); localStorage.setItem('toonkit_sheet_raw', e.target.value);}} placeholder="스프레드시트 URL" className="w-full p-4 bg-slate-50 rounded-2xl text-sm mb-4 outline-none border border-slate-100" />
                                <button onClick={() => {setPinInput(''); setIsSettingPin(true);}} className="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs mb-4">PIN 설정 변경</button>
                                <button onClick={() => setShowSettings(false)} className="w-full py-4 bg-pink-500 text-white rounded-2xl font-black shadow-lg">닫기</button>
                            </div>
                        )}

                        {isEditing ? (
                            <div className="space-y-4 pb-32">
                                <input type="text" value={currentToon.title} onChange={(e) => setCurrentToon({...currentToon, title:e.target.value})} placeholder="에피소드 제목" className="w-full p-5 rounded-2xl bg-white border-2 border-pink-50 text-lg font-bold outline-none shadow-sm" />
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="bg-white p-5 rounded-2xl border border-pink-50 shadow-sm">
                                        <p className="text-[10px] font-bold text-pink-300 mb-2 uppercase tracking-wider">{i === 0 ? "Cover" : `Page ${i+1}`}</p>
                                        <textarea value={p} onChange={(e) => {const next = [...currentToon.pages]; next[i] = e.target.value; setCurrentToon({...currentToon, pages:next});}} className="w-full min-h-[80px] outline-none text-slate-700 resize-none border-none bg-transparent" placeholder="..." />
                                    </div>
                                ))}
                                <div className="fixed bottom-8 left-6 right-6 z-[60]">
                                    <button onClick={saveToon} disabled={isSyncing} className={`w-full py-5 rounded-[2rem] font-black text-lg shadow-2xl flex items-center justify-center gap-3 transition-all ${isSyncing ? 'bg-slate-400' : 'bg-pink-600 text-white'}`}>
                                        {isSyncing ? <div className="spinner !border-white"></div> : <i data-lucide="cloud-upload"></i>}
                                        {isSyncing ? "클라우드 저장 중..." : "클라우드 저장 및 전송"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="grid gap-4 pb-10">
                                {toons.length === 0 ? (
                                    <div className="text-center py-24 opacity-30 italic text-sm">작성된 콘티가 없습니다.</div>
                                ) : (
                                    toons.map(t => (
                                        <div key={t.id} onClick={() => {setCurrentToon(t); setIsEditing(true);}} className="bg-white p-6 rounded-[2rem] shadow-sm active:scale-[0.98] transition-all relative group">
                                            <div className="flex justify-between items-center mb-4">
                                                <h2 className="font-black text-slate-800 truncate pr-8">{t.title}</h2>
                                                <button onClick={(e) => {e.stopPropagation(); deleteToon(t.id);}} className="text-slate-200 hover:text-red-400 border-none bg-transparent"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                            </div>
                                            <div className="flex gap-1">
                                                {t.pages.map((p, idx) => <div key={idx} className={`h-1 flex-1 rounded-full ${p?.trim() ? 'bg-pink-500' : 'bg-pink-50'}`} />)}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>