<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Perfect Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overflow: hidden; background-color: #FFF5F7; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        #root { height: 100%; width: 100%; }
        
        .pt-safe { padding-top: max(1.25rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1.5rem, var(--safe-bottom)); }
        
        .scroll-container { 
            height: 100%; overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none;
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        
        .checkbox-trigger {
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }

        .spinner { 
            width: 18px; height: 18px; 
            border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; 
            border-radius: 50%; animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .pass-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            transition: all 0.2s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        // üîê Í∞ÑÌé∏ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï (0224Î°ú Î≥ÄÍ≤ΩÎê®)
        const APP_PASSWORD = "0224"; 

        const App = () => {
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [passInput, setPassInput] = useState("");
            const [gapiInited, setGapiInited] = useState(false);
            
            const [toons, setToons] = useState(() => {
                const saved = localStorage.getItem('toonkit_data_v4');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [spreadsheetId, setSpreadsheetId] = useState(localStorage.getItem('toonkit_sheet_id') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState('');

            const tokenClient = useRef(null);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(''), 3000);
            };

            // 1. Load Data Function
            const loadData = async (targetId = spreadsheetId) => {
                if (!gapiInited || !targetId) return;
                
                const token = gapi.client.getToken();
                if (!token) {
                    setIsLoggedIn(false);
                    showToast("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§");
                    return;
                }

                setIsSyncing(true);
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: targetId,
                        range: 'A2:N100',
                    });
                    const rows = response.result.values;
                    if (rows) {
                        const fetched = rows.filter(r => r[12]).map(r => ({
                            title: r[0] || "",
                            pages: r.slice(1, 11).map(p => p || ""),
                            completed: r[11] === "TRUE",
                            id: r[12],
                            updatedAt: parseInt(r[13]) || Date.now()
                        }));
                        setToons(fetched.sort((a, b) => b.updatedAt - a.updatedAt));
                        showToast("Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å");
                    } else {
                        showToast("ÏãúÌä∏Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§");
                    }
                } catch (e) {
                    console.error("Load Error:", e);
                    if (e.status === 401) {
                        setIsLoggedIn(false);
                        localStorage.removeItem('google_auth_token');
                        showToast("Ïù∏Ï¶ùÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.");
                    } else {
                        showToast("ÏãúÌä∏ Î°úÎìú Ïã§Ìå®. IDÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            // GAPI Init
            useEffect(() => {
                const initGapi = async () => {
                    try {
                        await new Promise((resolve) => {
                            const interval = setInterval(() => {
                                if (typeof gapi !== 'undefined') {
                                    clearInterval(interval);
                                    resolve();
                                }
                            }, 100);
                        });

                        await new Promise(resolve => gapi.load('client', resolve));
                        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                        
                        setGapiInited(true);

                        const savedToken = localStorage.getItem('google_auth_token');
                        if (savedToken) {
                            const parsedToken = JSON.parse(savedToken);
                            gapi.client.setToken(parsedToken);
                            setIsLoggedIn(true);
                        }
                    } catch (e) {
                        console.error("GAPI Init Error:", e);
                    }
                };

                const initGsi = () => {
                    tokenClient.current = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: async (resp) => {
                            if (resp.error) return;
                            localStorage.setItem('google_auth_token', JSON.stringify(resp));
                            setIsLoggedIn(true);
                            showToast("Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ");
                            await loadData();
                        },
                    });
                };

                initGapi();
                
                const checkGsi = setInterval(() => {
                    if (typeof google !== 'undefined' && google.accounts) {
                        clearInterval(checkGsi);
                        initGsi();
                    }
                }, 100);

                return () => clearInterval(checkGsi);
            }, []);

            useEffect(() => {
                localStorage.setItem('toonkit_data_v4', JSON.stringify(toons));
                if (window.lucide) window.lucide.createIcons();
            }, [toons, isEditing, showSettings, isUnlocked, gapiInited]);

            // Password Handler
            const handlePassInput = (num) => {
                if (passInput.length >= 4) return;
                const nextPass = passInput + num;
                setPassInput(nextPass);
                
                if (nextPass === APP_PASSWORD) {
                    setTimeout(async () => {
                        setIsUnlocked(true);
                        if (gapiInited && isLoggedIn) {
                            await loadData();
                        }
                    }, 200);
                } else if (nextPass.length === 4) {
                    setTimeout(() => {
                        setPassInput("");
                        showToast("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.");
                    }, 300);
                }
            };

            const syncAllToSheets = async (currentList) => {
                if (!spreadsheetId || !isLoggedIn || !gapiInited) return;
                setIsSyncing(true);
                try {
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId,
                        range: 'A2:N100'
                    });

                    if (currentList.length > 0) {
                        const values = currentList.map(t => [
                            t.title, ...t.pages, t.completed ? "TRUE" : "FALSE", t.id, t.updatedAt
                        ]);
                        await gapi.client.sheets.spreadsheets.values.update({
                            spreadsheetId,
                            range: 'A2',
                            valueInputOption: 'USER_ENTERED',
                            resource: { values }
                        });
                    }
                } catch (e) {
                    console.error("Sync Error:", e);
                    showToast("Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù");
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleSave = async () => {
                if (!currentToon.title.trim()) return;
                const now = Date.now();
                const newToon = { ...currentToon, updatedAt: now };
                if (!newToon.id) newToon.id = now.toString();

                const newList = toons.find(t => t.id === newToon.id)
                    ? toons.map(t => t.id === newToon.id ? newToon : t)
                    : [newToon, ...toons];
                
                const sorted = newList.sort((a, b) => b.updatedAt - a.updatedAt);
                setToons(sorted);
                setIsEditing(false);
                await syncAllToSheets(sorted);
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if (!confirm("Ïù¥ ÏΩòÌã∞Î•º ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                const newList = toons.filter(t => t.id !== id);
                setToons(newList);
                await syncAllToSheets(newList);
                showToast("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
            };

            const toggleComplete = async (e, toon) => {
                e.stopPropagation();
                const updated = { ...toon, completed: !toon.completed, updatedAt: Date.now() };
                const newList = toons.map(t => t.id === toon.id ? updated : t).sort((a, b) => b.updatedAt - a.updatedAt);
                setToons(newList);
                await syncAllToSheets(newList);
            };

            if (!isUnlocked) {
                return (
                    <div className="h-full w-full flex flex-col items-center justify-center bg-white px-10">
                        <div className="mb-12 text-center">
                            <h1 className="text-3xl font-black text-pink-600 mb-2">ToonKit</h1>
                            <p className="text-slate-400 font-medium tracking-tight">ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                        </div>
                        
                        <div className="flex gap-6 mb-16">
                            {[0, 1, 2, 3].map(i => (
                                <div key={i} className={`pass-dot ${passInput.length > i ? 'bg-pink-500 scale-125 shadow-lg shadow-pink-200' : 'bg-slate-100'}`} />
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-8 w-full max-w-[280px]">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                <button key={num} onClick={() => handlePassInput(num.toString())} className="h-16 w-16 rounded-full flex items-center justify-center text-2xl font-bold text-slate-700 active:bg-pink-50 transition-colors">
                                    {num}
                                </button>
                            ))}
                            <div />
                            <button onClick={() => handlePassInput("0")} className="h-16 w-16 rounded-full flex items-center justify-center text-2xl font-bold text-slate-700 active:bg-pink-50 transition-colors">0</button>
                            <button onClick={() => setPassInput("")} className="h-16 w-16 rounded-full flex items-center justify-center text-slate-300 active:bg-pink-50 transition-colors">
                                <i data-lucide="delete"></i>
                            </button>
                        </div>

                        {toast && (
                            <div className="fixed bottom-12 bg-slate-800 text-white px-6 py-3 rounded-2xl text-sm font-bold animate-in fade-in slide-in-from-bottom-4">
                                {toast}
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="h-full w-full flex flex-col bg-[#FFF5F7]">
                    <header className="px-6 pt-safe pb-4 flex justify-between items-center bg-white border-b border-pink-100 shadow-sm shrink-0">
                        <div className="flex items-center gap-2">
                            {isEditing && (
                                <button onClick={() => setIsEditing(false)} className="p-2 text-pink-500">
                                    <i data-lucide="chevron-left" className="w-7 h-7"></i>
                                </button>
                            )}
                            <h1 className="text-2xl font-black text-pink-600 tracking-tighter">ToonKit</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-xl transition-colors ${showSettings ? 'bg-pink-100 text-pink-600' : (isLoggedIn ? 'text-pink-500 bg-pink-50' : 'text-slate-300')}`}>
                                <i data-lucide="settings"></i>
                            </button>
                            {!isEditing && (
                                <button 
                                    onClick={() => {
                                        setCurrentToon({ title: '', pages: Array(10).fill(''), completed: false });
                                        setIsEditing(true);
                                    }} 
                                    className="bg-pink-500 text-white px-5 py-2 rounded-xl font-black text-sm shadow-md active:scale-95"
                                >
                                    ÏÉà ÏΩòÌã∞
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container px-6 py-4">
                        {showSettings && (
                            <div className="mb-6 p-6 bg-white rounded-3xl shadow-xl border border-pink-50 animate-in slide-in-from-top-2">
                                <h3 className="font-bold text-slate-800 mb-4">ÏÑ§Ï†ï Î∞è ÎèôÍ∏∞Ìôî</h3>
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => tokenClient.current.requestAccessToken({prompt: 'consent'})} 
                                        className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-colors ${isLoggedIn ? 'bg-green-50 text-green-600' : 'bg-slate-100 text-slate-700'}`}
                                    >
                                        <i data-lucide={isLoggedIn ? "check-circle" : "user"}></i> {isLoggedIn ? "Íµ¨Í∏Ä Í≥ÑÏ†ï Ïó∞Í≤∞Îê®" : "Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏"}
                                    </button>
                                    <div className="relative">
                                        <input 
                                            type="text" 
                                            value={spreadsheetId} 
                                            onChange={(e) => {setSpreadsheetId(e.target.value); localStorage.setItem('toonkit_sheet_id', e.target.value);}} 
                                            placeholder="Íµ¨Í∏Ä ÏãúÌä∏ ID ÏûÖÎ†•" 
                                            className="w-full p-4 bg-slate-50 rounded-2xl text-sm border-2 border-transparent focus:border-pink-200 outline-none pr-12"
                                        />
                                        <i data-lucide="key" className="absolute right-4 top-4 w-5 h-5 text-slate-300"></i>
                                    </div>
                                    <button 
                                        onClick={() => loadData()} 
                                        disabled={isSyncing}
                                        className="w-full py-4 bg-pink-50 text-pink-600 rounded-2xl font-bold flex items-center justify-center gap-2 active:bg-pink-100 disabled:opacity-50"
                                    >
                                        {isSyncing ? <div className="spinner !border-pink-600 !border-t-transparent"></div> : <i data-lucide="download"></i>}
                                        ÏãúÌä∏ÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞
                                    </button>
                                </div>
                            </div>
                        )}

                        {isEditing ? (
                            <div className="space-y-4 pb-32">
                                <div className="bg-white p-4 rounded-2xl shadow-sm border border-pink-50 flex items-center gap-3">
                                    <div className="checkbox-trigger" onClick={() => setCurrentToon({...currentToon, completed: !currentToon.completed})}>
                                        <div className={`w-8 h-8 rounded-lg border-2 flex items-center justify-center transition-colors ${currentToon.completed ? 'bg-green-500 border-green-500' : 'border-slate-200 bg-white'}`}>
                                            {currentToon.completed && <i data-lucide="check" className="text-white w-5 h-5 stroke-[4]"></i>}
                                        </div>
                                    </div>
                                    <input 
                                        className="flex-1 text-xl font-bold outline-none text-slate-800 placeholder:text-slate-300"
                                        placeholder="ÏóêÌîºÏÜåÎìú Ï†úÎ™©"
                                        value={currentToon.title}
                                        onChange={(e) => setCurrentToon({...currentToon, title: e.target.value})}
                                    />
                                </div>
                                {currentToon.pages.map((text, idx) => (
                                    <div key={idx} className="bg-white p-5 rounded-3xl border border-pink-50 shadow-sm">
                                        <span className="text-[10px] font-black text-pink-300 tracking-widest uppercase block mb-2">{idx === 0 ? 'ÌëúÏßÄ' : `${idx}ÌéòÏù¥ÏßÄ`}</span>
                                        <textarea 
                                            className="w-full min-h-[120px] outline-none text-slate-700 resize-none leading-relaxed text-base"
                                            placeholder="Ïû•Î©¥ Î¨òÏÇ¨ Î∞è ÎåÄÏÇ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                            value={text}
                                            onChange={(e) => {
                                                const next = [...currentToon.pages];
                                                next[idx] = e.target.value;
                                                setCurrentToon({...currentToon, pages: next});
                                            }}
                                        />
                                    </div>
                                ))}
                                <div className="fixed bottom-10 left-6 right-6 flex gap-3 z-40">
                                    <button onClick={handleSave} className="flex-1 py-5 bg-pink-600 text-white rounded-[2rem] font-black text-lg shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                                        {isSyncing ? <div className="spinner"></div> : <i data-lucide="save"></i>}
                                        {isSyncing ? "ÎèôÍ∏∞Ìôî Ï§ë..." : "Ï†ÄÏû•ÌïòÍ≥† ÏãúÌä∏ ÏóÖÎç∞Ïù¥Ìä∏"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="grid gap-4 pb-20">
                                {toons.length === 0 && (
                                    <div className="py-20 text-center">
                                        <i data-lucide="layout" className="w-16 h-16 text-pink-100 mx-auto mb-4"></i>
                                        <p className="text-slate-400 font-medium">ÏûëÏÑ±Îêú ÏΩòÌã∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br/>ÏÉà ÏΩòÌã∞Î•º ÎàåÎü¨ ÏãúÏûëÌïòÏÑ∏Ïöî!</p>
                                    </div>
                                )}
                                {toons.map(toon => (
                                    <div 
                                        key={toon.id} 
                                        onClick={() => {setCurrentToon(toon); setIsEditing(true);}}
                                        className={`group relative p-6 rounded-[2.5rem] border-2 transition-all active:scale-[0.98] ${toon.completed ? 'bg-slate-50 border-slate-100 opacity-80' : 'bg-white border-white shadow-sm'}`}
                                    >
                                        <div className="flex items-start justify-between mb-4 pr-8">
                                            <div className="flex items-center gap-3">
                                                <div className="checkbox-trigger" onClick={(e) => toggleComplete(e, toon)}>
                                                    <div className={`w-8 h-8 rounded-lg border-2 flex items-center justify-center transition-colors ${toon.completed ? 'bg-green-500 border-green-500' : 'border-slate-200 bg-white'}`}>
                                                        {toon.completed && <i data-lucide="check" className="text-white w-5 h-5 stroke-[4]"></i>}
                                                    </div>
                                                </div>
                                                <h2 className={`text-lg font-black truncate max-w-[180px] ${toon.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>
                                                    {toon.title}
                                                </h2>
                                            </div>
                                            <button onClick={(e) => handleDelete(e, toon.id)} className="absolute top-6 right-6 p-2 text-slate-300 hover:text-red-500">
                                                <i data-lucide="trash-2" className="w-5 h-5"></i>
                                            </button>
                                        </div>
                                        <div className="flex gap-1.5 h-1.5 w-full">
                                            {toon.pages.map((p, i) => (
                                                <div key={i} className={`flex-1 rounded-full ${p.trim() ? (toon.completed ? 'bg-slate-300' : 'bg-pink-500') : 'bg-pink-50'}`} />
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {toast && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800/95 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-2xl z-50 animate-in fade-in slide-in-from-bottom-4">
                            {toast}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>