<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Stable Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100%; width: 100%; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-safe { padding-top: max(1rem, var(--safe-top)); }
        .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <!-- Firebase SDK - 전역 FB 객체 할당 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [toons, setToons] = useState([]);
            const [user, setUser] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), completed: false });
            const [fbReady, setFbReady] = useState(false);
            
            const dbRef = useRef(null);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, query } = window.FB;
                    
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        dbRef.current = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-v1';

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setFbReady(true);
                                const q = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'toons');
                                onSnapshot(q, (snapshot) => {
                                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    data.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                                    setToons(data);
                                    if (window.lucide) window.lucide.createIcons();
                                }, (err) => {
                                    console.error("Firestore Listener Error:", err);
                                });
                            }
                        });
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        setFbReady(true); // 에러가 나더라도 로딩 화면은 넘어가게 함
                    }
                };

                const checkInterval = setInterval(() => {
                    if (window.FB) {
                        initFirebase();
                        clearInterval(checkInterval);
                    }
                }, 200);
                return () => clearInterval(checkInterval);
            }, []);

            const handleSave = async () => {
                if (!user || !currentToon.title.trim()) return;
                const { doc, setDoc, serverTimestamp } = window.FB;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-v1';
                const toonId = currentToon.id || `toon_${Date.now()}`;
                
                try {
                    await setDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'toons', toonId), {
                        ...currentToon,
                        id: toonId,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    setIsEditing(false);
                } catch (e) {
                    alert("저장 실패: " + e.message);
                }
            };

            if (!fbReady) return (
                <div className="flex flex-col items-center justify-center h-screen bg-[#FFF5F7]">
                    <div className="spinner"></div>
                    <p className="mt-4 text-pink-500 font-bold text-sm">ToonKit 연결 중...</p>
                </div>
            );

            return (
                <div className="h-full w-full flex flex-col bg-[#FFF5F7]">
                    <header className="px-6 pt-safe pb-4 flex justify-between items-center bg-white/90 backdrop-blur-md border-b border-pink-100">
                        <div className="flex items-center gap-2">
                            {isEditing && (
                                <button onClick={() => setIsEditing(false)} className="p-2 -ml-2 text-pink-500">
                                    <i data-lucide="arrow-left"></i>
                                </button>
                            )}
                            <h1 className="text-xl font-black text-pink-600 tracking-tighter">ToonKit</h1>
                        </div>
                        {!isEditing && (
                            <button onClick={() => {setCurrentToon({id:null, title:'', pages:Array(10).fill(''), completed:false}); setIsEditing(true);}} className="bg-pink-500 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-lg">
                                새 콘티
                            </button>
                        )}
                    </header>

                    <main className="flex-1 scroll-container">
                        {isEditing ? (
                            <div className="p-6 space-y-4 pb-32">
                                <input 
                                    type="text" 
                                    value={currentToon.title} 
                                    onChange={(e) => setCurrentToon({...currentToon, title:e.target.value})} 
                                    placeholder="콘티 제목을 입력하세요" 
                                    className="w-full p-5 rounded-3xl bg-white border-2 border-pink-50 text-lg font-bold outline-none focus:border-pink-300" 
                                />
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="bg-white p-6 rounded-3xl border border-pink-50 shadow-sm">
                                        <p className="text-[10px] font-black text-pink-300 mb-2 uppercase">{i === 0 ? "표지 / 썸네일" : `${i}페이지`}</p>
                                        <textarea 
                                            value={p} 
                                            onChange={(e) => {
                                                const next = [...currentToon.pages];
                                                next[i] = e.target.value;
                                                setCurrentToon({...currentToon, pages:next});
                                            }} 
                                            className="w-full min-h-[80px] outline-none text-slate-700 text-sm leading-relaxed resize-none" 
                                            placeholder="내용을 입력하세요..." 
                                        />
                                    </div>
                                ))}
                                <div className="fixed bottom-8 left-6 right-6">
                                    <button onClick={handleSave} className="w-full py-5 rounded-[2rem] font-black text-lg bg-pink-600 text-white shadow-xl active:scale-95 transition-transform">
                                        클라우드에 저장
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="p-6 grid gap-4">
                                {toons.length === 0 ? (
                                    <div className="text-center py-20 opacity-30">
                                        <i data-lucide="cloud-off" className="mx-auto w-12 h-12 mb-4"></i>
                                        <p className="text-sm">작성된 콘티가 없습니다.</p>
                                    </div>
                                ) : (
                                    toons.map(t => (
                                        <div key={t.id} onClick={() => {setCurrentToon(t); setIsEditing(true);}} className="bg-white p-6 rounded-[2rem] shadow-sm border border-pink-50 active:scale-[0.98] transition-all">
                                            <h2 className="font-bold text-slate-800 text-lg mb-4 truncate">{t.title || "제목 없음"}</h2>
                                            <div className="flex gap-1.5 h-1.5 w-full bg-pink-50 rounded-full overflow-hidden">
                                                {t.pages.map((p, idx) => (
                                                    <div key={idx} className={`flex-1 ${p?.trim() ? 'bg-pink-500' : 'bg-transparent'}`} />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>