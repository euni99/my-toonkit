<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Cloud Sync</title>
    
    <!-- 1. 핵심 스타일 및 Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #FFF5F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #root { height: 100%; width: 100%; }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pt-safe { padding-top: max(1rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1rem, var(--safe-bottom)); }
        .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* 로딩 화면 스타일 */
        #initial-loader { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #FFF5F7; z-index: 9999; transition: opacity 0.5s; }
    </style>

    <!-- 2. 라이브러리 로드 (순서 중요) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Google API & GIS -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <!-- 초기 로딩 화면 (백색 화면 방지) -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #db2777; font-weight: bold; font-size: 14px;">ToonKit 불러오는 중...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // --- 설정 정보 ---
        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-v1';

        const App = () => {
            const [toons, setToons] = useState([]);
            const [user, setUser] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), completed: false });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [rawSheetInput, setRawSheetInput] = useState(localStorage.getItem('toonkit_sheet_raw') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [loading, setLoading] = useState(true);

            const tokenClient = useRef(null);

            // 초기 로더 제거
            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if (loader) loader.style.opacity = '0';
                setTimeout(() => loader && loader.remove(), 500);
            }, []);

            // 1. Firebase 인증
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth Error:", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. 실시간 데이터 동기화
            useEffect(() => {
                if (!user) return;

                const q = collection(db, 'artifacts', appId, 'public', 'data', 'toons');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    setToons(data);
                    setLoading(false);
                    if (window.lucide) window.lucide.createIcons();
                }, (err) => {
                    console.error("Firestore Error:", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // 3. Google API 초기화 (재시도 로직 포함)
            useEffect(() => {
                const initApis = async () => {
                    if (!window.gapi || !window.google) return;

                    try {
                        await new Promise(resolve => window.gapi.load('client', resolve));
                        await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                        
                        const savedToken = localStorage.getItem('google_auth_token');
                        if (savedToken) {
                            window.gapi.client.setToken(JSON.parse(savedToken));
                            setIsLoggedIn(true);
                        }

                        tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID, scope: SCOPES,
                            callback: async (resp) => {
                                if (resp.error) return;
                                localStorage.setItem('google_auth_token', JSON.stringify(resp));
                                setIsLoggedIn(true);
                                setErrorMsg("");
                            },
                        });
                    } catch (e) { console.error("GAPI Init Fail:", e); }
                };

                const timer = setInterval(() => {
                    if (window.gapi && window.google) {
                        initApis();
                        clearInterval(timer);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const extractSheetId = (input) => {
                if (!input) return '';
                if (input.includes('/d/')) {
                    return input.split('/d/')[1]?.split('/')[0] || input;
                }
                return input.trim();
            };

            const syncToSheets = async (targetData) => {
                const sId = extractSheetId(rawSheetInput);
                if (!sId || !isLoggedIn || !window.gapi?.client?.sheets) return;
                
                try {
                    const response = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId: sId });
                    const sheetName = response.result.sheets[0].properties.title;
                    const rows = targetData.map(t => [
                        t.title, ...t.pages, t.completed ? "완료" : "진행중", t.id, new Date().toLocaleString()
                    ]);
                    const header = ["제목", "P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8", "P9", "P10", "상태", "ID", "동기화시간"];

                    await window.gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: sId, 
                        range: `'${sheetName}'!A1`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [header, ...rows] }
                    });
                    setErrorMsg("");
                } catch (err) { 
                    console.error("Sheet Sync Error:", err);
                    setErrorMsg("시트 저장 실패: 권한 또는 로그인을 확인하세요.");
                }
            };

            const saveToon = async () => {
                if (!user || !currentToon.title.trim()) return;
                
                setIsSyncing(true);
                const toonId = currentToon.id || `toon_${Date.now()}`;
                const toonData = {
                    title: currentToon.title,
                    pages: currentToon.pages,
                    completed: currentToon.completed,
                    updatedAt: serverTimestamp()
                };

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'toons', toonId);
                    await setDoc(docRef, toonData, { merge: true });

                    if (isLoggedIn && rawSheetInput) {
                        const updatedList = toons.some(t => t.id === toonId) 
                            ? toons.map(t => t.id === toonId ? { ...t, ...toonData } : t)
                            : [{ id: toonId, ...toonData }, ...toons];
                        await syncToSheets(updatedList);
                    }

                    setIsEditing(false);
                } catch (err) {
                    console.error("Save Error:", err);
                    setErrorMsg("저장 실패. 네트워크 상태를 확인하세요.");
                } finally {
                    setIsSyncing(false);
                }
            };

            const deleteToon = async (id, e) => {
                e.stopPropagation();
                if (!user || !confirm("정말로 삭제하시겠습니까? 클라우드에서도 삭제됩니다.")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'toons', id));
                } catch (e) { console.error(e); }
            };

            return (
                <div className="h-full w-full flex flex-col bg-[#FFF5F7]">
                    {/* 상단바 */}
                    <header className="px-6 pt-safe pb-4 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-pink-100 z-50">
                        <div className="flex items-center gap-2">
                            {isEditing && (
                                <button onClick={() => setIsEditing(false)} className="p-2 -ml-2 text-pink-500">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                            )}
                            <h1 className="text-xl font-black text-pink-600 tracking-tight">ToonKit</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition-all ${isLoggedIn ? 'text-pink-600 bg-pink-50' : 'text-slate-300 bg-slate-50'}`}>
                                <i data-lucide="settings"></i>
                            </button>
                            {!isEditing && (
                                <button onClick={() => {setCurrentToon({id:null, title:'', pages:Array(10).fill(''), completed:false}); setIsEditing(true);}} className="bg-pink-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg shadow-pink-200 active:scale-95">
                                    새 콘티
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container relative">
                        {/* 설정 레이어 */}
                        {showSettings && (
                            <div className="absolute inset-x-0 top-0 p-6 bg-white border-b-2 border-pink-50 z-40 shadow-2xl animate-in slide-in-from-top duration-300">
                                <h3 className="text-xs font-black text-pink-400 uppercase tracking-widest mb-4">Sync Control</h3>
                                <input 
                                    type="text" 
                                    value={rawSheetInput} 
                                    onChange={(e) => {setRawSheetInput(e.target.value); localStorage.setItem('toonkit_sheet_raw', e.target.value);}} 
                                    placeholder="구글 스프레드시트 주소를 입력하세요" 
                                    className="w-full p-4 bg-slate-50 rounded-2xl text-sm mb-3 outline-none border border-slate-100 focus:border-pink-300 transition-all"
                                />
                                <button 
                                    onClick={() => tokenClient.current?.requestAccessToken()} 
                                    className={`w-full py-4 rounded-2xl font-bold text-sm mb-2 flex items-center justify-center gap-2 ${isLoggedIn ? 'bg-green-50 text-green-600' : 'bg-pink-50 text-pink-600'}`}
                                >
                                    <i data-lucide={isLoggedIn ? "check-circle" : "log-in"}></i>
                                    {isLoggedIn ? "구글 연동 완료" : "구글 계정 로그인"}
                                </button>
                                {errorMsg && <p className="text-[11px] text-red-500 font-bold text-center mt-2 mb-2">⚠️ {errorMsg}</p>}
                                <button onClick={() => setShowSettings(false)} className="w-full py-3 text-slate-400 font-bold text-xs mt-2 underline">설정 닫기</button>
                            </div>
                        )}

                        {isEditing ? (
                            <div className="p-6 space-y-4 pb-32">
                                <input 
                                    type="text" 
                                    value={currentToon.title} 
                                    onChange={(e) => setCurrentToon({...currentToon, title:e.target.value})} 
                                    placeholder="에피소드 제목 (예: 1화 - 시작)" 
                                    className="w-full p-5 rounded-3xl bg-white border-2 border-pink-50 text-lg font-black outline-none shadow-sm focus:border-pink-300" 
                                />
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="bg-white p-5 rounded-3xl border border-pink-50 shadow-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-[10px] font-black text-pink-300 uppercase tracking-widest">{i === 0 ? "Cover" : `Page ${i+1}`}</span>
                                            {p?.trim() && <i data-lucide="check" className="w-3 h-3 text-green-400"></i>}
                                        </div>
                                        <textarea 
                                            value={p} 
                                            onChange={(e) => {const next = [...currentToon.pages]; next[i] = e.target.value; setCurrentToon({...currentToon, pages:next});}} 
                                            className="w-full min-h-[100px] outline-none text-slate-700 resize-none border-none bg-transparent text-sm leading-relaxed" 
                                            placeholder="대사, 연출 등을 자유롭게 적으세요..." 
                                        />
                                    </div>
                                ))}
                                
                                {/* 하단 저장 버튼 */}
                                <div className="fixed bottom-8 left-6 right-6 z-50">
                                    <button 
                                        onClick={saveToon} 
                                        disabled={isSyncing || !currentToon.title.trim()} 
                                        className={`w-full py-5 rounded-[2rem] font-black text-lg shadow-2xl flex items-center justify-center gap-3 transition-all active:scale-95 ${isSyncing ? 'bg-slate-300' : 'bg-pink-600 text-white shadow-pink-200'}`}
                                    >
                                        {isSyncing ? <div className="spinner !border-white !w-5 !h-5"></div> : <i data-lucide="cloud-save"></i>}
                                        {isSyncing ? "동기화 중..." : "클라우드에 저장"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="p-6 grid gap-4 pb-10">
                                {toons.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-32 opacity-20">
                                        <i data-lucide="layout" className="w-16 h-16 mb-4"></i>
                                        <p className="font-bold text-sm">보관함이 비어있습니다</p>
                                    </div>
                                ) : (
                                    toons.map(t => (
                                        <div key={t.id} onClick={() => {setCurrentToon(t); setIsEditing(true);}} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-pink-50 active:scale-[0.98] transition-all relative overflow-hidden">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex-1 min-w-0 mr-4">
                                                    <h2 className="font-black text-slate-800 text-lg truncate">{t.title}</h2>
                                                    <p className="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">
                                                        {t.updatedAt ? new Date(t.updatedAt.seconds * 1000).toLocaleString('ko-KR') : '방금 전'}
                                                    </p>
                                                </div>
                                                <button onClick={(e) => deleteToon(t.id, e)} className="p-2 text-slate-200 hover:text-red-400 transition-colors">
                                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <div className="flex gap-1.5 h-1.5">
                                                {t.pages.map((p, idx) => (
                                                    <div key={idx} className={`flex-1 rounded-full transition-colors ${p?.trim() ? 'bg-pink-500' : 'bg-pink-50'}`} />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>