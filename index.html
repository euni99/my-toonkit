<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit Final</title>
    
    <!-- 외부 스크립트 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        :root { 
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom); 
        }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overflow: hidden; background-color: #FFF5F7; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            -webkit-user-select: none;
        }
        #root { height: 100%; width: 100%; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { 
            width: 20px; height: 20px; 
            border: 2px solid rgba(219, 39, 119, 0.2); border-top-color: #db2777; 
            border-radius: 50%; animation: spin 0.8s linear infinite; 
        }
        .pt-safe { padding-top: max(1.25rem, var(--safe-top)); }
        .pb-safe { padding-bottom: max(1.5rem, var(--safe-bottom)); }
        .scroll-container { 
            height: 100%; overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none;
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .pin-dot.active { background-color: #db2777; transform: scale(1.2); box-shadow: 0 0 10px rgba(219, 39, 119, 0.4); }
        .pin-dot.inactive { background-color: #fce7f3; border: 1.5px solid #fbcfe8; }
        
        .setting-card { position: relative; z-index: 50; }
        button, .cursor-pointer { -webkit-tap-highlight-color: transparent; outline: none; }
        textarea { -webkit-user-select: text; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ⚠️ 사용자 설정 영역 (구글 클라우드 콘솔 정보)
        const CLIENT_ID = '1088995464661-ft9gdmqcc90in7k5cdcussocote4mi92.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBxvFtk2jiBisjoubvv2olJEgyoyNQ_k0w';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        const App = () => {
            // --- 상태 관리 ---
            const [toons, setToons] = useState(() => {
                const saved = localStorage.getItem('toonkit_v3_data');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [isEditing, setIsEditing] = useState(false);
            const [currentToon, setCurrentToon] = useState({ id: null, title: '', pages: Array(10).fill(''), completed: false });
            const [isSyncing, setIsSyncing] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [spreadsheetId, setSpreadsheetId] = useState(localStorage.getItem('toonkit_sheet_id') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            
            const [savedPin, setSavedPin] = useState(localStorage.getItem('toonkit_pin') || '');
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [isSettingPin, setIsSettingPin] = useState(false);

            const tokenClient = useRef(null);

            // --- 초기화: GAPI & GIS ---
            useEffect(() => {
                const initGapi = async () => {
                    try {
                        if (!window.gapi) return;
                        await new Promise(resolve => window.gapi.load('client', resolve));
                        await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                        
                        const savedToken = localStorage.getItem('google_auth_token');
                        if (savedToken) {
                            const tokenObj = JSON.parse(savedToken);
                            window.gapi.client.setToken(tokenObj);
                            setIsLoggedIn(true);
                        }
                    } catch (e) { console.error("GAPI Init Error:", e); }
                };

                const initGis = () => {
                    if (!window.google) return;
                    tokenClient.current = window.google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, 
                        scope: SCOPES,
                        callback: async (resp) => {
                            if (resp.error) { setErrorMsg("인증 실패"); return; }
                            localStorage.setItem('google_auth_token', JSON.stringify(resp));
                            setIsLoggedIn(true);
                            setErrorMsg("구글 연동 성공!");
                            setTimeout(() => setErrorMsg(''), 2000);
                        },
                    });
                };

                const timer = setTimeout(() => {
                    initGapi();
                    initGis();
                }, 500);
                return () => clearTimeout(timer);
            }, []);

            // --- 아이콘 및 데이터 저장 ---
            useEffect(() => {
                localStorage.setItem('toonkit_v3_data', JSON.stringify(toons));
                if (window.lucide) window.lucide.createIcons();
            }, [toons, isEditing, showSettings, isUnlocked, isSettingPin, pinInput]);

            // --- 시트에서 데이터 가져오기 (Pull) ---
            const loadFromSheets = async (silent = false) => {
                if (!spreadsheetId || !isLoggedIn) {
                    if(!silent) setErrorMsg("로그인 및 시트 ID가 필요합니다.");
                    return;
                }
                setIsSyncing(true);
                try {
                    const ss = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId });
                    const targetSheetName = ss.result.sheets[0].properties.title;
                    const response = await window.gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId,
                        range: `'${targetSheetName}'!A2:N200`, // 최대 200개 행
                    });

                    const rows = response.result.values;
                    if (rows && rows.length > 0) {
                        const importedToons = rows.map(row => ({
                            title: row[0] || "제목 없음",
                            pages: row.slice(1, 11),
                            completed: row[11] === "완료",
                            id: row[12] || Date.now().toString() + Math.random(),
                        }));
                        setToons(importedToons);
                        if(!silent) setErrorMsg("최신 데이터를 불러왔습니다.");
                    }
                } catch (err) {
                    console.error("Load Error:", err);
                    if(!silent) setErrorMsg("동기화 실패. 설정을 확인하세요.");
                } finally {
                    setIsSyncing(false);
                    if(!silent) setTimeout(() => setErrorMsg(''), 2000);
                }
            };

            // --- PIN 입력 로직 (동기화 트리거 포함) ---
            const handlePinPress = async (num) => {
                if (pinInput.length >= 4) return;
                const newPin = pinInput + num;
                setPinInput(newPin);
                
                if (newPin.length === 4) {
                    if (isSettingPin) {
                        localStorage.setItem('toonkit_pin', newPin);
                        setSavedPin(newPin);
                        setIsSettingPin(false);
                        setIsUnlocked(true);
                        setPinInput('');
                        setShowSettings(false);
                    } else if (newPin === savedPin) {
                        // 로그인 및 시트 정보가 있으면 즉시 동기화 시도
                        if (isLoggedIn && spreadsheetId) {
                            setErrorMsg("동기화 중...");
                            await loadFromSheets(true); 
                        }
                        setIsUnlocked(true);
                        setPinInput('');
                        setErrorMsg("");
                    } else {
                        setErrorMsg("PIN 번호가 일치하지 않습니다.");
                        setTimeout(() => { setPinInput(''); setErrorMsg(''); }, 500);
                    }
                }
            };

            const handleLogin = () => {
                if (tokenClient.current) {
                    tokenClient.current.requestAccessToken({ prompt: isLoggedIn ? '' : 'consent' });
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('google_auth_token');
                if (window.gapi && window.gapi.client) window.gapi.client.setToken(null);
                setIsLoggedIn(false);
                setErrorMsg("로그아웃 되었습니다.");
            };

            // --- 시트로 데이터 내보내기 (Push) ---
            const syncToSheets = async (targetData) => {
                if (!spreadsheetId || !isLoggedIn) return;
                setIsSyncing(true);
                try {
                    const ss = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId });
                    const targetSheetName = ss.result.sheets[0].properties.title;
                    const rows = targetData.map(t => [
                        t.title, 
                        ...t.pages, 
                        t.completed ? "완료" : "진행중", 
                        t.id,
                        new Date().toLocaleString()
                    ]);
                    const header = ["제목", "P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8", "P9", "P10", "상태", "고유ID", "마지막업데이트"];
                    await window.gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId, 
                        range: `'${targetSheetName}'!A1`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [header, ...rows] }
                    });
                } catch (err) {
                    console.error("Sync Error:", err);
                    if (err.status === 401) handleLogout();
                    setErrorMsg("시트 저장 실패.");
                } finally { 
                    setIsSyncing(false); 
                }
            };

            const saveToon = async () => {
                if (!currentToon.title.trim()) {
                    setErrorMsg("제목을 입력해주세요.");
                    return;
                }
                const newToon = currentToon.id ? currentToon : { ...currentToon, id: Date.now().toString() };
                const newList = currentToon.id 
                    ? toons.map(t => t.id === currentToon.id ? newToon : t) 
                    : [newToon, ...toons];
                
                setToons(newList);
                if (isLoggedIn && spreadsheetId) {
                    await syncToSheets(newList);
                }
                setIsEditing(false);
            };

            // --- 잠금 화면 ---
            if ((savedPin && !isUnlocked) || isSettingPin) {
                return (
                    <div className="h-full w-full flex flex-col items-center justify-center bg-[#FFF5F7] px-10 fixed inset-0 z-[100]">
                        <div className="mb-10 text-center">
                            <div className="w-20 h-20 bg-pink-500 rounded-[2rem] flex items-center justify-center text-white mx-auto mb-6 shadow-2xl shadow-pink-200">
                                <i data-lucide={isSettingPin ? "shield-check" : "lock"} className="w-8 h-8"></i>
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 tracking-tight">
                                {isSettingPin ? "새 PIN 설정" : "ToonKit"}
                            </h2>
                            {isSyncing && <p className="text-xs text-pink-500 mt-2 font-bold animate-pulse">최신 데이터 동기화 중...</p>}
                        </div>
                        <div className="flex gap-5 mb-14">
                            {[0,1,2,3].map(i => (
                                <div key={i} className={`pin-dot ${pinInput.length > i ? 'active' : 'inactive'}`}></div>
                            ))}
                        </div>
                        <div className="grid grid-cols-3 gap-6 w-full max-w-[300px]">
                            {[1,2,3,4,5,6,7,8,9].map(n => (
                                <button key={n} onClick={() => handlePinPress(n.toString())} className="h-16 w-16 rounded-2xl bg-white text-2xl font-bold text-slate-700 shadow-sm active:bg-pink-100 active:scale-90 transition-all flex items-center justify-center">{n}</button>
                            ))}
                            <div className="h-16 w-16"></div>
                            <button onClick={() => handlePinPress('0')} className="h-16 w-16 rounded-2xl bg-white text-2xl font-bold text-slate-700 shadow-sm active:bg-pink-100 active:scale-90 transition-all flex items-center justify-center">0</button>
                            <button onClick={() => setPinInput(pinInput.slice(0, -1))} className="h-16 w-16 rounded-2xl flex items-center justify-center text-slate-300 active:text-pink-500 active:scale-90 transition-all"><i data-lucide="delete"></i></button>
                        </div>
                        {isSettingPin && <button onClick={() => setIsSettingPin(false)} className="mt-8 text-slate-400 font-bold underline">취소</button>}
                        {errorMsg && <p className="mt-8 text-pink-600 font-bold text-sm bg-pink-50 px-5 py-2 rounded-full shadow-sm">{errorMsg}</p>}
                    </div>
                );
            }

            // --- 메인 화면 ---
            return (
                <div className="h-full w-full flex flex-col bg-[#FFF5F7]">
                    <header className="px-6 pt-safe pb-4 flex justify-between items-center bg-white border-b border-pink-100 shrink-0 shadow-sm">
                        <div className="flex items-center gap-2">
                            {isEditing && <button onClick={() => setIsEditing(false)} className="mr-2 text-pink-500 p-1"><i data-lucide="arrow-left"></i></button>}
                            <h1 className="text-2xl font-black text-pink-600 tracking-tighter">ToonKit</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-xl transition-all ${showSettings ? 'bg-pink-100 text-pink-600' : (isLoggedIn ? 'text-pink-600 bg-pink-50' : 'text-slate-300')}`}>
                                <i data-lucide="settings"></i>
                            </button>
                            {!isEditing && (
                                <button onClick={() => {setCurrentToon({id:null, title:'', pages:Array(10).fill(''), completed:false}); setIsEditing(true);}} className="bg-pink-500 text-white px-5 py-2 rounded-xl font-black text-sm shadow-lg shadow-pink-100 active:scale-95 transition-all">
                                    새 콘티
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 scroll-container px-6 py-6">
                        {showSettings && (
                            <div className="mb-8 p-6 bg-white rounded-[2.5rem] border-2 border-pink-50 shadow-xl animate-in fade-in slide-in-from-top-4 duration-300 setting-card">
                                <section className="mb-6">
                                    <p className="text-[10px] font-black text-pink-400 uppercase tracking-widest mb-4">클라우드 동기화</p>
                                    <button 
                                        onClick={() => loadFromSheets(false)}
                                        disabled={isSyncing}
                                        className="w-full py-4 bg-blue-50 text-blue-600 rounded-2xl font-bold text-sm mb-3 flex items-center justify-center gap-2 active:scale-95 transition-all"
                                    >
                                        <i data-lucide="refresh-cw" className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`}></i>
                                        {isSyncing ? "데이터 확인 중..." : "수동 불러오기 (Import)"}
                                    </button>

                                    <p className="text-[10px] font-black text-pink-400 uppercase tracking-widest mb-4 mt-6">보안 및 계정</p>
                                    <button onClick={handleLogin} className={`w-full py-4 rounded-2xl font-bold text-sm mb-3 flex items-center justify-center gap-2 active:scale-95 transition-all ${isLoggedIn ? 'bg-green-50 text-green-600' : 'bg-pink-50 text-pink-600'}`}>
                                        <i data-lucide={isLoggedIn ? "check-circle" : "log-in"} className="w-4 h-4"></i>
                                        {isLoggedIn ? "구글 연동됨" : "구글 로그인 연동"}
                                    </button>
                                    <button onClick={() => { setPinInput(''); setIsSettingPin(true); }} className="w-full py-4 bg-slate-50 text-slate-600 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all">
                                        <i data-lucide="key" className="w-4 h-4"></i>
                                        PIN 번호 설정/변경
                                    </button>
                                </section>
                                
                                <section className="mb-8">
                                    <p className="text-[10px] font-black text-pink-400 uppercase tracking-widest mb-4">스프레드시트 ID</p>
                                    <input 
                                        type="text" value={spreadsheetId} 
                                        onChange={(e) => {setSpreadsheetId(e.target.value); localStorage.setItem('toonkit_sheet_id', e.target.value);}}
                                        placeholder="시트 주소의 ID 부분을 입력하세요" 
                                        className="w-full p-4 bg-slate-50 rounded-2xl text-sm mb-2 outline-none border border-slate-100 focus:border-pink-200 transition-all font-mono"
                                    />
                                    <p className="text-[9px] text-slate-400 px-1">시트 주소 /d/와 /edit 사이의 문자열입니다.</p>
                                </section>
                                <button onClick={() => setShowSettings(false)} className="w-full py-5 bg-pink-500 text-white rounded-[1.5rem] font-black shadow-lg shadow-pink-100">닫기</button>
                            </div>
                        )}

                        {isEditing ? (
                            <div className="space-y-4 pb-40">
                                <div className="bg-white p-2 rounded-2xl shadow-sm border border-pink-50">
                                    <input type="text" value={currentToon.title} onChange={(e) => setCurrentToon({...currentToon, title:e.target.value})} placeholder="에피소드 제목을 적어주세요" className="w-full p-4 rounded-xl bg-transparent text-xl font-black outline-none placeholder:text-slate-300" />
                                </div>
                                {currentToon.pages.map((p, i) => (
                                    <div key={i} className="bg-white p-5 rounded-3xl border border-pink-50 shadow-sm transition-all focus-within:border-pink-200 focus-within:shadow-md">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-[10px] font-black text-pink-300 uppercase tracking-tighter">{i === 0 ? "00 COVER" : `PAGE ${String(i).padStart(2, '0')}`}</span>
                                            <span className="text-[10px] text-slate-200 font-bold">{p.length}자</span>
                                        </div>
                                        <textarea value={p} onChange={(e) => {const next = [...currentToon.pages]; next[i] = e.target.value; setCurrentToon({...currentToon, pages:next});}} className="w-full min-h-[100px] outline-none text-slate-700 resize-none bg-transparent leading-relaxed" placeholder="장면 묘사나 대사를 입력하세요..." />
                                    </div>
                                ))}
                                <div className="fixed bottom-10 left-6 right-6 z-40">
                                    <button onClick={saveToon} disabled={isSyncing} className={`w-full py-5 rounded-[2rem] font-black text-lg shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-all ${isSyncing ? 'bg-slate-300 text-slate-500' : 'bg-pink-600 text-white shadow-pink-200'}`}>
                                        {isSyncing ? <div className="spinner" style={{borderTopColor:'#fff'}}></div> : <i data-lucide="cloud-upload" className="w-5 h-5"></i>}
                                        {isSyncing ? "동기화 중..." : "저장 및 시트 전송"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="grid gap-5">
                                {toons.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-32 opacity-20 text-center">
                                        <i data-lucide="layout" className="w-16 h-16 mb-4"></i>
                                        <p className="font-bold">아직 작성된 콘티가 없습니다.<br/>새 콘티를 시작하거나 불러오세요!</p>
                                    </div>
                                ) : (
                                    toons.map(t => (
                                        <div key={t.id} onClick={() => {setCurrentToon(t); setIsEditing(true);}} className="bg-white p-6 rounded-[2.5rem] border-2 border-white shadow-sm active:scale-95 active:shadow-inner transition-all cursor-pointer group">
                                            <div className="flex justify-between items-start mb-5">
                                                <div className="flex-1 min-w-0">
                                                    <h2 className="font-black text-slate-800 text-lg truncate mb-1">{t.title}</h2>
                                                    <p className="text-[10px] text-slate-400 font-medium">마지막 수정: {new Date().toLocaleDateString()}</p>
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); if(confirm("정말 삭제할까요? 시트에서도 삭제됩니다.")){ const n = toons.filter(x=>x.id!==t.id); setToons(n); if(isLoggedIn) syncToSheets(n); } }} className="text-slate-200 hover:text-red-400 p-2 transition-colors"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                            </div>
                                            <div className="flex gap-1.5">
                                                {t.pages.map((p, idx) => (
                                                    <div key={idx} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${p.trim() ? 'bg-pink-500 shadow-[0_0_8px_rgba(236,72,153,0.3)]' : 'bg-pink-50'}`} />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>

                    {errorMsg && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-2xl text-xs font-bold shadow-2xl z-[60] flex items-center gap-2 animate-in fade-in slide-in-from-bottom-2">
                            <i data-lucide="info" className="w-3 h-3 text-pink-400"></i>
                            {errorMsg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>