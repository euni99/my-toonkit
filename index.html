<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ToonKit - Master Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; -webkit-user-select: none; }
        #root { height: 100dvh; width: 100vw; display: flex; flex-direction: column; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(219, 39, 119, 0.1); border-top-color: #db2777; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar { display: none; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body class="bg-[#FFF5F7] transition-colors duration-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global SDK Export
        window.FirebaseSDK = { 
            initializeApp, getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence,
            getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [isPinVerified, setIsPinVerified] = useState(false);
            const [pin, setPin] = useState("");
            const [toons, setToons] = useState([]);
            const [currentToon, setCurrentToon] = useState({ title: '', status: 'Idea', pages: Array(10).fill('') });
            const [isEditing, setIsEditing] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [darkMode, setDarkMode] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'toonkit-master-shared';
            const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzjF4-7CgHPX7p2sLOYzwUff6sqvYCyx3HLp3BUBWBC1pxrRy022xUKLt4jmbTTY2HBQA/exec";

            // 필수 조건: 자동 로그인 상태 유지 (setPersistence)
            useEffect(() => {
                const init = async () => {
                    if (!window.FirebaseSDK) return;
                    const { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, getFirestore } = window.FirebaseSDK;
                    
                    try {
                        const app = initializeApp(firebaseConfig);
                        authRef.current = getAuth(app);
                        dbRef.current = getFirestore(app);

                        // 브라우저 로컬 저장소에 로그인 세션 유지 설정
                        await setPersistence(authRef.current, browserLocalPersistence);

                        onAuthStateChanged(authRef.current, (u) => {
                            setUser(u);
                            setIsLoading(false);
                        });
                    } catch (e) {
                        console.error("Init Error:", e);
                        setIsLoading(false);
                    }
                };

                const checkSDK = setInterval(() => {
                    if (window.FirebaseSDK) {
                        init();
                        clearInterval(checkSDK);
                    }
                }, 100);
                return () => clearInterval(checkSDK);
            }, []);

            // 필수 조건: 기기간 실시간 동기화
            useEffect(() => {
                if (!user || !isPinVerified || !dbRef.current) return;
                const { collection, onSnapshot } = window.FirebaseSDK;
                const colRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'instatoons');
                
                const unsub = onSnapshot(colRef, (snap) => {
                    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setToons(items.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)));
                    if (window.lucide) window.lucide.createIcons();
                }, (err) => console.error("Sync Error:", err));
                
                return () => unsub();
            }, [user, isPinVerified]);

            const handleGoogleLogin = async () => {
                const { GoogleAuthProvider, signInWithPopup } = window.FirebaseSDK;
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(authRef.current, provider);
                } catch (e) { console.error("Login Error:", e); }
            };

            const handleLogout = async () => {
                const { signOut } = window.FirebaseSDK;
                if (!confirm("로그아웃 하시겠습니까? (다시 구글 로그인이 필요하게 됩니다)")) return;
                await signOut(authRef.current);
                setIsPinVerified(false);
                setPin("");
            };

            // 필수 조건: 스프레드시트 연동
            const saveToSheet = async (data) => {
                if (!SHEET_WEBHOOK_URL) return;
                try {
                    await fetch(SHEET_WEBHOOK_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...data, user: user?.email, timestamp: new Date().toLocaleString() })
                    });
                } catch (e) { console.error("Sheet Error:", e); }
            };

            const handleSave = async () => {
                if (!currentToon.title.trim()) return;
                setIsSyncing(true);
                const { doc, addDoc, updateDoc, collection } = window.FirebaseSDK;
                try {
                    const now = new Date().toISOString();
                    const toonData = { ...currentToon, updatedAt: now, authorEmail: user?.email };
                    const colPath = ['artifacts', appId, 'public', 'data', 'instatoons'];

                    if (currentToon.id) {
                        await updateDoc(doc(dbRef.current, ...colPath, currentToon.id), toonData);
                    } else {
                        await addDoc(collection(dbRef.current, ...colPath), { ...toonData, createdAt: now });
                    }
                    await saveToSheet(toonData);
                    setIsEditing(false);
                    setCurrentToon({ title: '', status: 'Idea', pages: Array(10).fill('') });
                } catch (e) { console.error("Save Error:", e); }
                setIsSyncing(false);
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if (!confirm("정말 삭제할까요?")) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'instatoons', id));
            };

            if (isLoading) return (
                <div className="fixed inset-0 flex flex-col items-center justify-center bg-[#FFF5F7] dark:bg-slate-900">
                    <div className="spinner mb-4"></div>
                    <p className="text-pink-500 font-black animate-pulse">마스터 클라우드 연결 중...</p>
                </div>
            );

            // 필수 조건: 구글 로그인 연동 (Persistence를 통해 매번 로그인 안 함)
            if (!user) return (
                <div className="flex items-center justify-center min-h-screen p-6 bg-pink-50 dark:bg-slate-900 transition-colors">
                    <div className="w-full max-w-sm p-8 glass-card rounded-[2.5rem] shadow-xl text-center border border-pink-100">
                        <div className="mb-6 inline-flex p-4 bg-pink-100 rounded-full text-pink-500"><i data-lucide="cloud" className="w-10 h-10"></i></div>
                        <h1 className="text-3xl font-black mb-2 text-pink-600 italic tracking-tighter">ToonKit</h1>
                        <p className="text-sm text-slate-400 mb-8 font-bold leading-relaxed">작가님의 모든 콘티를 기기 상관없이<br/>실시간으로 동기화합니다.</p>
                        <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border-2 border-slate-100 dark:border-slate-700 dark:bg-slate-800 rounded-2xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-all shadow-sm hover:border-pink-300">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                            Google 계정으로 시작하기
                        </button>
                    </div>
                </div>
            );

            // 필수 조건: 간편비밀번호 기능 (PIN)
            if (!isPinVerified) return (
                <div className="flex items-center justify-center min-h-screen p-6 bg-pink-50 dark:bg-slate-900 transition-colors">
                    <div className="w-full max-w-sm p-8 glass-card rounded-[2.5rem] shadow-xl text-center">
                        <div className="flex justify-end mb-2">
                             <button onClick={handleLogout} className="text-[10px] font-black text-slate-300 underline uppercase tracking-widest">Login Change</button>
                        </div>
                        <div className="mb-6 inline-flex p-4 bg-pink-100 rounded-full text-pink-500 shadow-inner"><i data-lucide="lock" className="w-8 h-8"></i></div>
                        <h2 className="text-xl font-black mb-6">보안 PIN 입력</h2>
                        <input type="password" value={pin} onChange={(e) => {
                            setPin(e.target.value);
                            if(e.target.value === "1234") setIsPinVerified(true); 
                        }} placeholder="••••" className="w-full text-center text-4xl tracking-[0.5em] py-4 bg-white dark:bg-slate-800 border-2 border-pink-100 dark:border-slate-700 rounded-2xl outline-none mb-4 focus:border-pink-400 transition-all" maxLength={4} autoFocus />
                        <p className="text-xs text-slate-400 font-medium">작가님의 소중한 아이디어를 보호합니다</p>
                    </div>
                </div>
            );

            return (
                <div className={`flex flex-col h-full transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-white' : 'bg-[#FFF5F7] text-slate-800'}`}>
                    <header className={`px-6 pt-[max(env(safe-area-inset-top),20px)] pb-4 flex justify-between items-center ${darkMode ? 'bg-slate-900 shadow-xl' : 'bg-white shadow-sm'} border-b ${darkMode ? 'border-slate-800' : 'border-pink-50'}`}>
                        <div className="flex items-center gap-3">
                            {isEditing ? (
                                <button onClick={() => setIsEditing(false)} className="p-1 -ml-2 text-pink-400"><i data-lucide="chevron-left" className="w-8 h-8"></i></button>
                            ) : (
                                <div className="p-1.5 bg-pink-500 rounded-xl text-white shadow-lg shadow-pink-200">
                                    {/* 필수 조건: 톱니바퀴 표시 */}
                                    <i data-lucide="settings" className="w-5 h-5 animate-spin-slow"></i>
                                </div>
                            )}
                            <h1 className="text-2xl font-black text-pink-600 italic tracking-tighter">ToonKit</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 transition-transform active:scale-75">{darkMode ? <i data-lucide="sun" className="text-yellow-400"></i> : <i data-lucide="moon" className="text-pink-300"></i>}</button>
                            {!isEditing && <button onClick={() => setIsEditing(true)} className="px-4 py-2 bg-pink-500 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all">+ 새 콘티</button>}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto px-6 py-6 pb-32">
                        {isEditing ? (
                            <div className="space-y-6 max-w-xl mx-auto">
                                <input type="text" value={currentToon.title} onChange={(e) => setCurrentToon({...currentToon, title: e.target.value})} placeholder="어떤 이야기를 그리실 건가요?" className={`w-full p-4 rounded-2xl border-2 font-bold text-xl outline-none transition-all ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-pink-50 text-slate-800 focus:border-pink-300'}`} />
                                <div className="space-y-4">
                                    {currentToon.pages.map((p, i) => (
                                        <div key={i} className={`p-4 rounded-[2rem] border-2 transition-all ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-white shadow-sm'}`}>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="w-6 h-6 rounded-lg bg-pink-50 text-pink-400 flex items-center justify-center text-[10px] font-black">{i === 0 ? '표지' : i+1}</span>
                                                <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Script Block</p>
                                            </div>
                                            <textarea value={p} onChange={(e) => {
                                                const newPages = [...currentToon.pages];
                                                newPages[i] = e.target.value;
                                                setCurrentToon({...currentToon, pages: newPages});
                                            }} placeholder="장면 내용을 입력하세요..." className="w-full bg-transparent resize-none outline-none min-h-[100px] leading-relaxed font-medium" />
                                        </div>
                                    ))}
                                </div>
                                <div className="fixed bottom-8 left-6 right-6 flex justify-center pointer-events-none">
                                    <button onClick={handleSave} disabled={isSyncing} className="w-full max-w-md p-5 bg-pink-600 text-white rounded-[2rem] font-black shadow-2xl pointer-events-auto active:scale-95 transition-all flex items-center justify-center gap-3">
                                        {isSyncing ? <div className="spinner w-5 h-5 border-2 border-white border-t-transparent"></div> : <i data-lucide="cloud-upload"></i>}
                                        {isSyncing ? "동기화 중..." : "클라우드 보관함에 저장"}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 gap-4 max-w-xl mx-auto">
                                <div className="flex justify-between items-center mb-2 px-1">
                                    <span className="text-[10px] font-black text-slate-400 tracking-widest uppercase flex items-center gap-1.5"><i data-lucide="user" className="w-3 h-3"></i> {user?.email}</span>
                                    <button onClick={handleLogout} className="text-[10px] font-black text-pink-400 underline uppercase tracking-widest">Logout</button>
                                </div>
                                {toons.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-32 opacity-20">
                                        <i data-lucide="book-open" className="w-16 h-16 mb-4"></i>
                                        <p className="font-bold tracking-tighter">보관함이 비어있습니다</p>
                                    </div>
                                ) : toons.map(t => (
                                    <div key={t.id} onClick={() => { setCurrentToon(t); setIsEditing(true); }} className={`p-6 rounded-[2.5rem] border-2 cursor-pointer transition-all active:scale-[0.98] ${darkMode ? 'bg-slate-800 border-slate-800' : 'bg-white border-white shadow-[0_10px_30px_rgba(255,182,193,0.1)] hover:border-pink-100'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1 pr-4">
                                                <h3 className="font-bold text-xl mb-3 truncate tracking-tight">{t.title || "제목 없음"}</h3>
                                                <div className="flex items-center gap-3">
                                                    <p className="text-xs text-pink-400 font-bold flex items-center gap-1.5"><i data-lucide="check-circle" className="w-3.5 h-3.5"></i> {t.pages.filter(p=>p && p.trim()).length} / 10</p>
                                                    <span className="text-[10px] opacity-10">|</span>
                                                    <p className="text-[10px] opacity-40 font-bold uppercase tracking-tighter">{new Date(t.updatedAt).toLocaleString()}</p>
                                                </div>
                                            </div>
                                            <button onClick={(e) => handleDelete(e, t.id)} className="p-2 text-slate-100 hover:text-red-400 transition-colors"><i data-lucide="trash-2" className="w-5 h-5"></i></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        window.addEventListener('load', refreshIcons);
        document.addEventListener('click', () => setTimeout(refreshIcons, 50));
    </script>
</body>
</html>